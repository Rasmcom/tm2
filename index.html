<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ملف شواهد الأداء الوظيفي للمعلم</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 25px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s, visibility 0.5s, top 0.5s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .notification.show {
            opacity: 1;
            visibility: visible;
            top: 30px;
        }

        .notification.success {
            background-color: #4CAF50;
        }

        .notification.error {
            background-color: #f44336;
        }
        
        /* Header Styles */
        header {
            background-color: #333;
            padding: 15px 0;
            position: relative;
        }
        
        .header-gradient {
            height: 4px;
            background: linear-gradient(to left, #4CAF50, #2196F3);
            margin-top: 5px;
        }
        
        .header-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .header-top {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            margin: 0 auto;
        }
        
        .logo {
            width: 60px;
            height: auto;
            margin-left: 15px;
        }
        
        .site-title {
            color: white;
            font-size: 20px;
            font-weight: 700;
        }
        
        .header-info {
            color: white;
            font-size: 14px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            width: 100%;
        }
        
        .header-info p {
            margin: 0 10px;
        }
        
        /* Layout */
        .main-layout {
            display: flex;
            min-height: calc(100vh - 200px); /* Adjust for header and footer */
        }
        
        /* Sidebar Navigation */
        .sidebar {
            width: 80px;
            background-color: #333;
            position: sticky;
            top: 0;
            height: 100vh;
            transition: width 0.3s;
            overflow: hidden;
            z-index: 100;
        }
        
        .sidebar:hover {
            width: 220px;
        }
        
        .nav-list {
            list-style: none;
            padding: 20px 0;
        }
        
        .nav-item {
            margin-bottom: 5px;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: white;
            text-decoration: none;
            white-space: nowrap;
            transition: background-color 0.3s;
        }
        
        .nav-link:hover, .nav-link.active {
            background-color: #4CAF50;
        }
        
        .nav-icon {
            font-size: 20px;
            min-width: 50px;
            text-align: center;
        }
        
        .nav-text {
            margin-right: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .sidebar:hover .nav-text {
            opacity: 1;
        }
        
        /* Content Area */
        .content-area {
            flex: 1;
            padding: 20px;
            transition: margin-right 0.3s;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
            padding: 20px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            min-height: 400px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background-color: #0b7dda;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 5px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #777;
        }
        
        /* Footer Styles */
        footer {
            background-color: #333;
            color: white;
            padding: 20px 0;
            text-align: center;
            margin-top: 30px;
        }
        
        .footer-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .footer-logo {
            width: 40px;
            height: auto;
        }
        
        .footer-link {
            color: #2196F3;
            text-decoration: none;
        }
        
        /* Introduction Page - Enhanced Design */
        .intro-section {
            margin-bottom: 40px;
            position: relative;
            padding: 25px;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .intro-section::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(to bottom, #4CAF50, #2196F3);
        }
        
        .intro-section h2 {
            color: #2196F3;
            margin-bottom: 20px;
            font-size: 24px;
            position: relative;
            padding-bottom: 10px;
        }
        
        .intro-section h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 60px;
            height: 3px;
            background-color: #4CAF50;
        }
        
        .intro-section p {
            line-height: 1.8;
            margin-bottom: 15px;
            font-size: 16px;
            text-align: justify;
        }
        
        .vision-mission-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 30px;
        }
        
        .vision-box, .mission-box {
            flex: 1;
            min-width: 300px;
            padding: 25px;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .vision-box:hover, .mission-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .vision-box {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            border-top: 4px solid #2196F3;
        }
        
        .mission-box {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            border-top: 4px solid #4CAF50;
        }
        
        .vision-box h2, .mission-box h2 {
            font-size: 22px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .vision-box h2 {
            color: #2196F3;
        }
        
        .mission-box h2 {
            color: #4CAF50;
        }
        
        .vision-box h2 i, .mission-box h2 i {
            margin-left: 10px;
            font-size: 24px;
        }
        
        .vision-box p, .mission-box p {
            line-height: 1.8;
            text-align: justify;
        }
        
        .values-container {
            margin-top: 40px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .values-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, #4CAF50, #2196F3);
        }
        
        .values-container h2 {
            color: #333;
            margin-bottom: 25px;
            text-align: center;
            font-size: 24px;
        }
        
        .values-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .value-item {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            align-items: flex-start;
        }
        
        .value-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .value-icon {
            width: 40px;
            height: 40px;
            background-color: #e8f5e9;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            flex-shrink: 0;
        }
        
        .value-icon i {
            color: #4CAF50;
            font-size: 18px;
        }
        
        .value-content h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #333;
        }
        
        .value-content p {
            color: #666;
            line-height: 1.6;
            font-size: 14px;
        }
        
        /* Leaders Words Page - Enhanced Design */
        .leaders-header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
            padding-bottom: 15px;
        }
        
        .leaders-header h2 {
            font-size: 28px;
            color: #333;
        }
        
        .leaders-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background: linear-gradient(to right, #4CAF50, #2196F3);
        }
        
        .leaders-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
        }
        
        .leader-card {
            width: 100%;
            max-width: 350px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            background-color: #fff;
            position: relative;
        }
        
        .leader-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .leader-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, #4CAF50, #2196F3);
        }
        
        .leader-image-container {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 5px solid #fff;
            overflow: hidden;
            margin: 30px auto 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .leader-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }
        
        .leader-card:hover .leader-image {
            transform: scale(1.1);
        }
        
        .leader-content {
            padding: 20px 25px 30px;
            text-align: center;
        }
        
        .leader-content h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 18px;
            line-height: 1.4;
            position: relative;
            padding-bottom: 15px;
        }
        
        .leader-content h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 2px;
            background-color: #4CAF50;
        }
        
        .leader-content p {
            line-height: 1.8;
            text-align: justify;
            color: #555;
            font-size: 15px;
            position: relative;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .leader-content p::before {
            content: '\201C';
            font-size: 60px;
            position: absolute;
            top: -15px;
            right: 10px;
            color: #e0e0e0;
            font-family: serif;
        }
        
        /* CV Page */
        .cv-section {
            margin-bottom: 30px;
        }
        
        .cv-section h3 {
            color: #2196F3;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        
        .certificate-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        
        .certificate-item {
            width: 150px;
            height: 150px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }
        
        .certificate-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .certificate-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            background-color: #f5f5f5;
            color: #777;
            font-size: 40px;
        }
        
        .courses-list {
            margin-top: 15px;
        }
        
        .course-item {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .delete-btn {
            background-color: #ff5252;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        /* Performance Indicators Page */
        .performance-item {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .performance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .performance-title {
            font-size: 18px;
            font-weight: 700;
        }
        
        .performance-description {
            margin-bottom: 15px;
            color: #555;
        }
        
        .performance-uploads {
            margin-bottom: 15px;
        }
        
        .upload-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .upload-item {
            width: 100px;
            height: 100px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }
        
        .upload-item img, .upload-item iframe {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .upload-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            background-color: #f5f5f5;
            color: #777;
            font-size: 30px;
        }
        
        .upload-file-icon {
            font-size: 40px;
            color: #2196F3;
        }
        
        .performance-rating {
            margin-top: 15px;
        }
        
        .rating-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* New Rating Slider Style */
        .rating-slider-container {
            width: 100%;
            max-width: 300px;
            margin-top: 10px;
        }
        
        .rating-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e0e0e0;
            outline: none;
            margin-bottom: 10px;
        }
        
        .rating-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2196F3;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .rating-slider::-webkit-slider-thumb:hover {
            background: #0b7dda;
            transform: scale(1.2);
        }
        
        .rating-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2196F3;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }
        
        .rating-slider::-moz-range-thumb:hover {
            background: #0b7dda;
            transform: scale(1.2);
        }
        
        .rating-numbers {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }
        
        .rating-number {
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .rating-number.active {
            background-color: #2196F3;
            color: white;
        }
        
        .rating-value {
            font-size: 16px;
            font-weight: bold;
            color: #2196F3;
            margin-right: 10px;
        }
        
        .note-btn {
            background-color: #f0f0f0;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .note-btn:hover {
            background-color: #e0e0e0;
        }
        
        .note-icon {
            font-size: 20px;
            color: #555;
        }
        
        .performance-note {
            margin-top: 15px;
            display: none;
        }
        
        .performance-note textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
            min-height: 80px;
        }
        
        .performance-result {
            margin-top: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .performance-result::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, #4CAF50, #2196F3);
        }
        
        .result-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
        }
        
        .result-score {
            font-size: 48px;
            font-weight: 700;
            color: #4CAF50;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .result-details {
            margin-top: 20px;
            text-align: right;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .result-details p {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed #e0e0e0;
        }
        
        .result-details p:last-child {
            border-bottom: none;
        }
        
        /* Documentation Page */
        .documentation-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .documentation-section h3 {
            color: #2196F3;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        
        /* Improvement Plan Page */
        .improvement-section {
            margin-bottom: 30px;
        }
        
        .improvement-form {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .improvement-list {
            margin-top: 20px;
        }
        
        .improvement-item {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .improvement-item h4 {
            margin-bottom: 10px;
            color: #2196F3;
        }
        
        .priority-high {
            color: #ff5252;
            font-weight: 600;
        }
        
        .priority-medium {
            color: #FFA726;
            font-weight: 600;
        }
        
        .priority-low {
            color: #4CAF50;
            font-weight: 600;
        }
        
        /* Image Preview Modal */
        .image-preview-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
        }
        
        .image-preview-content {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
        }
        
        .preview-image {
            max-width: 90%;
            max-height: 90%;
        }
        
        .close-preview {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 30px;
            color: white;
            cursor: pointer;
        }
        
        /* Performance Item Colors */
        .performance-item:nth-child(1) { border-top: 4px solid #FF5252; }
        .performance-item:nth-child(2) { border-top: 4px solid #FF9800; }
        .performance-item:nth-child(3) { border-top: 4px solid #FFEB3B; }
        .performance-item:nth-child(4) { border-top: 4px solid #4CAF50; }
        .performance-item:nth-child(5) { border-top: 4px solid #2196F3; }
        .performance-item:nth-child(6) { border-top: 4px solid #673AB7; }
        .performance-item:nth-child(7) { border-top: 4px solid #9C27B0; }
        .performance-item:nth-child(8) { border-top: 4px solid #E91E63; }
        .performance-item:nth-child(9) { border-top: 4px solid #795548; }
        .performance-item:nth-child(10) { border-top: 4px solid #607D8B; }
        .performance-item:nth-child(11) { border-top: 4px solid #009688; }
        
        /* Responsive Styles - FIXED FOR MOBILE */
        @media (max-width: 768px) {
            .header-top {
                flex-direction: column;
                text-align: center;
            }
            
            .logo-container {
                margin-bottom: 10px;
                margin-left: 0;
            }
            
            .header-info {
                text-align: center;
                margin-bottom: 10px;
                flex-direction: column;
                gap: 5px;
            }
            
            .main-layout {
                flex-direction: row; /* Keep as row instead of column */
            }
            
            .sidebar {
                width: 60px; /* Smaller width on mobile */
                height: 100vh;
                position: fixed; /* Fixed position */
                top: 0;
                right: 0;
                z-index: 100;
            }
            
            .sidebar:hover {
                width: 180px; /* Smaller expanded width on mobile */
            }
            
            .nav-list {
                display: flex;
                flex-direction: column; /* Keep as column */
                padding: 10px 0;
            }
            
            .nav-item {
                margin: 5px 0;
            }
            
            .nav-link {
                padding: 10px;
            }
            
            .nav-icon {
                min-width: 40px;
                font-size: 18px;
            }
            
            .content-area {
                margin-right: 60px; /* Add margin to account for sidebar */
                width: calc(100% - 60px);
                padding: 15px;
            }
            
            .leader-card {
                max-width: 100%;
            }
            
            .vision-mission-container {
                flex-direction: column;
            }
            
            .values-grid {
                grid-template-columns: 1fr;
            }
            
            /* Adjust modal for mobile */
            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 15px;
            }
            
            /* Adjust form elements for mobile */
            .form-control, .btn {
                font-size: 14px;
                padding: 8px 15px;
            }
            
            /* Make sure the sidebar is always visible */
            .sidebar {
                display: block !important;
            }
        }
        
        /* For very small screens */
        @media (max-width: 480px) {
            .sidebar {
                width: 50px;
            }
            
            .content-area {
                margin-right: 50px;
                width: calc(100% - 50px);
                padding: 10px;
            }
            
            .nav-icon {
                min-width: 30px;
                font-size: 16px;
            }
            
            .site-title {
                font-size: 16px;
            }
            
            .header-info {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="notification" class="notification"></div>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="header-top">
                    <div class="logo-container">
                        <img src="https://salogos.org/wp-content/uploads/2021/11/UntiTtled-1-1300x988.png" alt="شعار وزارة التعليم" class="logo">
                        <h1 class="site-title">ملف شواهد الأداء الوظيفي للمعلم</h1>
                    </div>
                </div>
                <div class="header-info" id="headerInfo">
                    <p id="teacherName">اسم المعلم: -</p>
                    <p id="educationDept">الإدارة التعليمية: -</p>
                    <p id="schoolName">المدرسة: -</p>
                    <p id="academicYear">العام الدراسي: -</p>
                </div>
            </div>
        </div>
        <div class="header-gradient"></div>
    </header>
    
    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-tab="home">
                        <i class="fas fa-home nav-icon"></i>
                        <span class="nav-text">الرئيسية</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-tab="intro">
                        <i class="fas fa-info-circle nav-icon"></i>
                        <span class="nav-text">مقدمة الملف</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-tab="leaders">
                        <i class="fas fa-quote-right nav-icon"></i>
                        <span class="nav-text">كلمات القادة</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-tab="cv">
                        <i class="fas fa-user-tie nav-icon"></i>
                        <span class="nav-text">السيرة الذاتية</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-tab="performance">
                        <i class="fas fa-chart-line nav-icon"></i>
                        <span class="nav-text">شواهد الأداء</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-tab="documentation">
                        <i class="fas fa-clipboard-check nav-icon"></i>
                        <span class="nav-text">التوثيق والمتابعة</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-tab="improvement">
                        <i class="fas fa-tasks nav-icon"></i>
                        <span class="nav-text">خطة التحسين</span>
                    </a>
                </li>
            </ul>
        </div>
        
        <!-- Content Area -->
        <div class="content-area">
            <!-- Home Tab -->
            <div class="tab-content active" id="home-content">
                <h2>البيانات الأساسية</h2>
                <div class="form-group">
                    <label for="teacherNameInput">اسم المعلم</label>
                    <input type="text" id="teacherNameInput" class="form-control" placeholder="أدخل اسم المعلم">
                </div>
                <div class="form-group">
                    <label for="educationDeptInput">الإدارة التعليمية</label>
                    <input type="text" id="educationDeptInput" class="form-control" placeholder="أدخل اسم الإدارة التعليمية">
                </div>
                <div class="form-group">
                    <label for="schoolNameInput">المدرسة</label>
                    <input type="text" id="schoolNameInput" class="form-control" placeholder="أدخل اسم المدرسة">
                </div>
                <div class="form-group">
                    <label for="academicYearInput">العام الدراسي</label>
                    <input type="text" id="academicYearInput" class="form-control" placeholder="أدخل العام الدراسي">
                </div>
                <button class="btn" id="saveBasicDataBtn">حفظ البيانات</button>
            </div>
            
            <!-- Introduction Tab -->
            <div class="tab-content" id="intro-content">
                <div class="intro-section">
                    <h2>مقدمة ملف شواهد الأداء الوظيفي للمعلم</h2>
                    <p>إن التعليم هو الأساس الذي تُبنى عليه الأوطان، والركيزة التي تقوم عليها النهضة الحضارية والتنموية في أي مجتمع. وقد أولت المملكة العربية السعودية، في ظل قيادتها الرشيدة، التعليم أهمية كبرى بوصفه محركًا أساسيًا لرؤية المملكة 2030 وأداة فاعلة لبناء الإنسان وتمكينه من مهارات القرن الحادي والعشرين.</p>
                    <p>ومن هذا المنطلق، جاء إعداد هذا الملف الخاص بـ شواهد الأداء الوظيفي للمعلم، ليُبرز ما تم إنجازه من ممارسات تربوية وتعليمية تسهم في تحسين نواتج التعلم، وتوثيق العمل المهني المستند إلى معايير الجودة والتميز، وقياس مستوى تحقق المهارات والمعارف بما يدعم المسيرة التعليمية.</p>
                    <p>وإيمانًا بأن المعلم هو حجر الزاوية في تطوير التعليم، فإن هذا الملف يُعد انعكاسًا حقيقيًا لدوره الريادي في بناء الأجيال وصناعة المستقبل، مستلهمين في ذلك كلمات ولاة أمرنا التي تُعد نبراسًا نهتدي به.</p>
                </div>
                
                <div class="vision-mission-container">
                    <div class="vision-box">
                        <h2><i class="fas fa-eye"></i> الرؤية</h2>
                        <p>تحقيق تعليم نوعي عالي الجودة، يُسهم في بناء جيل واعٍ ومتمكن، منافس عالميًا، ومؤمن بقيمه الوطنية.</p>
                    </div>
                    
                    <div class="mission-box">
                        <h2><i class="fas fa-bullseye"></i> الرسالة</h2>
                        <p>تقديم تعليم محفّز على الإبداع والتميّز، قائم على معايير مهنية، يعزز من دور المعلم في قيادة التعلم، ويركز على تمكين المتعلم من المهارات والمعارف اللازمة لمواكبة التغيرات العالمية.</p>
                    </div>
                </div>
                
                <div class="values-container">
                    <h2>القيم</h2>
                    <div class="values-grid">
                        <div class="value-item">
                            <div class="value-icon">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="value-content">
                                <h3>المواطنة</h3>
                                <p>تعزيز الانتماء الوطني والاعتزاز بالهوية السعودية.</p>
                            </div>
                        </div>
                        
                        <div class="value-item">
                            <div class="value-icon">
                                <i class="fas fa-award"></i>
                            </div>
                            <div class="value-content">
                                <h3>الجودة</h3>
                                <p>الالتزام بمعايير الأداء والتميّز المؤسسي.</p>
                            </div>
                        </div>
                        
                        <div class="value-item">
                            <div class="value-icon">
                                <i class="fas fa-hands-helping"></i>
                            </div>
                            <div class="value-content">
                                <h3>المسؤولية</h3>
                                <p>أداء الواجبات المهنية بأمانة ومصداقية.</p>
                            </div>
                        </div>
                        
                        <div class="value-item">
                            <div class="value-icon">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <div class="value-content">
                                <h3>الابتكار</h3>
                                <p>دعم الإبداع وتوظيف الحلول التقنية الحديثة.</p>
                            </div>
                        </div>
                        
                        <div class="value-item">
                            <div class="value-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="value-content">
                                <h3>التمكين</h3>
                                <p>بناء القدرات وتطوير الكفاءات التعليمية.</p>
                            </div>
                        </div>
                        
                        <div class="value-item">
                            <div class="value-icon">
                                <i class="fas fa-balance-scale"></i>
                            </div>
                            <div class="value-content">
                                <h3>العدالة</h3>
                                <p>تحقيق المساواة وتكافؤ الفرص التعليمية.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Leaders Words Tab -->
            <div class="tab-content" id="leaders-content">
                <div class="leaders-header">
                    <h2>كلمات القادة</h2>
                </div>
                
                <div class="leaders-container">
                    <div class="leader-card">
                        <div class="leader-image-container">
                            <img src="https://i.top4top.io/p_3485a0uv82.jpeg" alt="الملك سلمان بن عبدالعزيز" class="leader-image">
                        </div>
                        <div class="leader-content">
                            <h3>كلمة خادم الحرمين الشريفين الملك سلمان بن عبدالعزيز آل سعود – حفظه الله</h3>
                            <p>"إن التعليم في السعودية هو الركيزة الأساسية للتنمية، ونحن نولي أبناءنا الطلاب والطالبات جلّ اهتمامنا، ونوفر لهم أفضل سبل التعليم الحديث، فهم عماد المستقبل وأمله."</p>
                        </div>
                    </div>
                    
                    <div class="leader-card">
                        <div class="leader-image-container">
                            <img src="https://h.top4top.io/p_3485vnxie0.jpeg" alt="الأمير محمد بن سلمان" class="leader-image">
                        </div>
                        <div class="leader-content">
                            <h3>كلمة صاحب السمو الملكي الأمير محمد بن سلمان بن عبدالعزيز – ولي العهد رئيس مجلس الوزراء – حفظه الله</h3>
                            <p>"طموحنا أن نبني وطنًا أكثر ازدهارًا، يجد فيه كل مواطن ما يتمناه، ويشارك في بناء مستقبله. ولن يكون ذلك إلا بتعليم رائد يصنع جيلاً واعيًا ومؤهلاً للمنافسة عالميًا."</p>
                        </div>
                    </div>
                    
                    <div class="leader-card">
                        <div class="leader-image-container">
                            <img src="https://h.top4top.io/p_34853oi4r1.jpeg" alt="وزير التعليم" class="leader-image">
                        </div>
                        <div class="leader-content">
                            <h3>كلمة معالي وزير التعليم يوسف البنيان</h3>
                            <p>"نسعى في وزارة التعليم إلى تطوير المنظومة التعليمية بما يتماشى مع مستهدفات رؤية 2030، من خلال تمكين المعلم، وتحسين نواتج التعلم، وتوفير بيئة تعليمية محفزة للتميّز والإبداع."</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- CV Tab -->
            <div class="tab-content" id="cv-content">
                <h2>السيرة الذاتية</h2>
                
                <div class="cv-section">
                    <h3>البيانات الأساسية</h3>
                    <div class="form-group">
                        <label for="fullNameInput">الاسم الكامل</label>
                        <input type="text" id="fullNameInput" class="form-control" placeholder="أدخل الاسم الكامل">
                    </div>
                    <div class="form-group">
                        <label for="specialtyInput">التخصص</label>
                        <input type="text" id="specialtyInput" class="form-control" placeholder="أدخل التخصص">
                    </div>
                    <div class="form-group">
                        <label for="qualificationInput">المؤهل العلمي</label>
                        <input type="text" id="qualificationInput" class="form-control" placeholder="أدخل المؤهل العلمي">
                    </div>
                    <div class="form-group">
                        <label for="yearsOfExperienceInput">سنوات الخبرة</label>
                        <input type="number" id="yearsOfExperienceInput" class="form-control" placeholder="أدخل عدد سنوات الخبرة">
                    </div>
                    <button class="btn" id="saveCvDataBtn">حفظ البيانات</button>
                </div>
                
                <div class="cv-section">
                    <h3>الرخصة المهنية</h3>
                    <div class="form-group">
                        <label for="licenseUpload">رفع صورة الرخصة المهنية</label>
                        <input type="file" id="licenseUpload" accept="image/*" style="display: none;">
                        <button class="btn" id="licenseUploadBtn">اختر صورة الرخصة</button>
                    </div>
                    <div class="certificate-container">
                        <div class="certificate-item" id="licensePreview">
                            <div class="certificate-placeholder">+</div>
                        </div>
                    </div>
                </div>
                
                <div class="cv-section">
                    <h3>شهادات الشكر والتقدير</h3>
                    <div class="form-group">
                        <label for="certificateUpload">رفع شهادات الشكر والتقدير (الحد الأقصى 8 شهادات)</label>
                        <input type="file" id="certificateUpload" accept="image/*" style="display: none;">
                        <button class="btn" id="certificateUploadBtn">اختر شهادة</button>
                    </div>
                    <div class="certificate-container" id="certificatesContainer">
                        <div class="certificate-item certificate-add">
                            <div class="certificate-placeholder">+</div>
                        </div>
                    </div>
                </div>
                
                <div class="cv-section">
                    <h3>الدورات التدريبية</h3>
                    <div class="form-group">
                        <label for="courseNameInput">اسم الدورة</label>
                        <input type="text" id="courseNameInput" class="form-control" placeholder="أدخل اسم الدورة">
                    </div>
                    <div class="form-group">
                        <label for="courseProviderInput">الجهة المقدمة</label>
                        <input type="text" id="courseProviderInput" class="form-control" placeholder="أدخل اسم الجهة المقدمة">
                    </div>
                    <div class="form-group">
                        <label for="courseDateInput">تاريخ الدورة</label>
                        <input type="date" id="courseDateInput" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="courseHoursInput">عدد الساعات</label>
                        <input type="number" id="courseHoursInput" class="form-control" placeholder="أدخل عدد ساعات الدورة">
                    </div>
                    <button class="btn" id="addCourseBtn">إضافة دورة</button>
                    
                    <div class="courses-list" id="coursesList">
                        <!-- Courses will be added here dynamically -->
                    </div>
                </div>
            </div>
            
            <!-- Performance Tab -->
            <div class="tab-content" id="performance-content">
                <h2>شواهد الأداء الوظيفي</h2>
                
                <div id="performanceItems">
                    <!-- Performance items will be added here dynamically -->
                </div>
                
                <div class="performance-result">
                    <div class="result-title">نتيجة التقييم الذاتي</div>
                    <div class="result-score" id="totalScore">0%</div>
                    <div class="result-details" id="scoreDetails"></div>
                </div>
            </div>
            
            <!-- Documentation Tab -->
            <div class="tab-content" id="documentation-content">
                <h2>التوثيق والمتابعة</h2>
                
                <div class="documentation-section">
                    <h3>المتابعة الأولى</h3>
                    <div class="form-group">
                        <label for="firstFollowupDate">تاريخ المتابعة</label>
                        <input type="date" id="firstFollowupDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="firstFollowupName">اسم المتابع</label>
                        <input type="text" id="firstFollowupName" class="form-control" placeholder="أدخل اسم المتابع">
                    </div>
                    <div class="form-group">
                        <label for="firstFollowupNotes">ملاحظات المتابعة</label>
                        <textarea id="firstFollowupNotes" class="form-control" rows="4" placeholder="أدخل ملاحظات المتابعة"></textarea>
                    </div>
                    <button class="btn" id="saveFirstFollowupBtn">حفظ المتابعة الأولى</button>
                </div>
                
                <div class="documentation-section">
                    <h3>المتابعة الثانية</h3>
                    <div class="form-group">
                        <label for="secondFollowupDate">تاريخ المتابعة</label>
                        <input type="date" id="secondFollowupDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="secondFollowupName">اسم المتابع</label>
                        <input type="text" id="secondFollowupName" class="form-control" placeholder="أدخل اسم المتابع">
                    </div>
                    <div class="form-group">
                        <label for="secondFollowupNotes">ملاحظات المتابعة</label>
                        <textarea id="secondFollowupNotes" class="form-control" rows="4" placeholder="أدخل ملاحظات المتابعة"></textarea>
                    </div>
                    <button class="btn" id="saveSecondFollowupBtn">حفظ المتابعة الثانية</button>
                </div>
                
                <div class="documentation-section">
                    <h3>التوصيات</h3>
                    <div class="form-group">
                        <label for="recommendations">التوصيات العامة</label>
                        <textarea id="recommendations" class="form-control" rows="6" placeholder="أدخل التوصيات العامة"></textarea>
                    </div>
                    <button class="btn" id="saveRecommendationsBtn">حفظ التوصيات</button>
                </div>
            </div>
            
            <!-- Improvement Tab -->
            <div class="tab-content" id="improvement-content">
                <h2>خطة التحسين المقترحة</h2>
                
                <div class="improvement-section">
                    <p>بناءً على التقييم الذاتي وملاحظات المتابعة، يمكن وضع خطة تحسين للجوانب التي تحتاج إلى تطوير في الأداء الوظيفي.</p>
                    
                    <div class="improvement-form">
                        <div class="form-group">
                            <label for="improvementArea">مجال التحسين</label>
                            <select id="improvementArea" class="form-control">
                                <option value="">اختر مجال التحسين</option>
                                <option value="أداء الواجبات الوظيفية">أداء الواجبات الوظيفية</option>
                                <option value="التفاعل مع المجتمع المهني">التفاعل مع المجتمع المهني</option>
                                <option value="التفاعل مع أولياء الأمور">التفاعل مع أولياء الأمور</option>
                                <option value="تنويع استراتيجيات التدريس">تنويع استراتيجيات التدريس</option>
                                <option value="تحسين نتائج المتعلمين">تحسين نتائج المتعلمين</option>
                                <option value="إعداد وتنفيذ خطة التعلم">إعداد وتنفيذ خطة التعلم</option>
                                <option value="توظيف التقنيات والوسائل">توظيف التقنيات والوسائل</option>
                                <option value="تهيئة البيئة التعليمية">تهيئة البيئة التعليمية</option>
                                <option value="الإدارة الصفية">الإدارة الصفية</option>
                                <option value="تحليل نتائج المتعلمين">تحليل نتائج المتعلمين</option>
                                <option value="تنوع أساليب التقويم">تنوع أساليب التقويم</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="improvementPriority">أولوية التحسين</label>
                            <select id="improvementPriority" class="form-control">
                                <option value="">اختر أولوية التحسين</option>
                                <option value="عالية">عالية</option>
                                <option value="متوسطة">متوسطة</option>
                                <option value="منخفضة">منخفضة</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="improvementGoal">هدف التحسين</label>
                            <input type="text" id="improvementGoal" class="form-control" placeholder="أدخل هدف التحسين">
                        </div>
                        <div class="form-group">
                            <label for="improvementActions">الإجراءات المقترحة</label>
                            <textarea id="improvementActions" class="form-control" rows="4" placeholder="أدخل الإجراءات المقترحة"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="improvementStartDate">تاريخ البداية</label>
                            <input type="date" id="improvementStartDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="improvementEndDate">تاريخ النهاية</label>
                            <input type="date" id="improvementEndDate" class="form-control">
                        </div>
                        <button class="btn" id="addImprovementBtn">إضافة خطة تحسين</button>
                    </div>
                    
                    <div class="improvement-list" id="improvementList">
                        <!-- Improvement plans will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Note Modal -->
    <div class="modal" id="noteModal">
        <div class="modal-content">
            <span class="close-modal" id="closeNoteModal">&times;</span>
            <h2>إضافة ملاحظة</h2>
            <div class="form-group">
                <label for="noteText">الملاحظة</label>
                <textarea id="noteText" class="form-control" rows="6" placeholder="أدخل ملاحظتك هنا"></textarea>
            </div>
            <button class="btn" id="saveNoteBtn">حفظ الملاحظة</button>
        </div>
    </div>
    
    <!-- Image Preview Modal -->
    <div class="image-preview-modal" id="imagePreviewModal">
        <span class="close-preview" id="closePreviewModal">&times;</span>
        <div class="image-preview-content">
            <img src="" alt="معاينة الصورة" class="preview-image" id="previewImage">
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirmModal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <h2 id="confirmTitle" style="margin-bottom: 15px;">هل أنت متأكد؟</h2>
            <p id="confirmText" style="margin: 20px 0;"></p>
            <div>
                <button class="btn" id="confirmYesBtn" style="background-color: #f44336; margin-left: 10px;">نعم، حذف</button>
                <button class="btn" id="confirmNoBtn" style="background-color: #aaa;">إلغاء</button>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <span>جميع الحقوق محفوظة لقناة رسم للتصميم والخدمات التعليمية</span>
                <img src="https://h.top4top.io/p_3453yqc3h0.png" alt="شعار رسم" class="footer-logo">
                <a href="https://t.me/Rasm_MA1" target="_blank" class="footer-link">https://t.me/Rasm_MA1</a>
            </div>
        </div>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, addDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        // This is now correctly handled by parsing the __firebase_config variable provided by the environment.
        const firebaseConfig = JSON.parse(
            typeof __firebase_config !== 'undefined' 
            ? __firebase_config 
            : '{}'
        );
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';


        // --- Global Variables ---
        let db, auth, userId;
        let unsubscribeListeners = []; // To store snapshot listeners
        let confirmCallback = null; // For the custom confirm modal
        let currentNoteItemId = null;
        
        // Performance Indicators Data (static)
        const performanceIndicators = [
            { id: 'performance_1', title: 'أداء الواجبات الوظيفية', description: 'مدى التزام المعلم بأداء واجباته الوظيفية وفق اللوائح والأنظمة المعتمدة.', weight: 10 },
            { id: 'performance_2', title: 'التفاعل مع المجتمع المهني', description: 'مشاركة المعلم في الأنشطة المهنية والتعاون مع الزملاء والمجتمع المدرسي.', weight: 10 },
            { id: 'performance_3', title: 'التفاعل مع أولياء الأمور', description: 'التواصل الفعال مع أولياء الأمور وإشراكهم في العملية التعليمية.', weight: 10 },
            { id: 'performance_4', title: 'تنويع استراتيجيات التدريس', description: 'استخدام استراتيجيات تدريس متنوعة تناسب احتياجات المتعلمين وأنماط تعلمهم.', weight: 10 },
            { id: 'performance_5', title: 'تحسين نتائج المتعلمين', description: 'العمل على تحسين نتائج المتعلمين وتطوير مستوياتهم التحصيلية.', weight: 10 },
            { id: 'performance_6', title: 'إعداد وتنفيذ خطة التعلم', description: 'إعداد وتنفيذ خطط تعليمية فعالة تحقق أهداف المنهج.', weight: 10 },
            { id: 'performance_7', title: 'توظيف التقنيات والوسائل', description: 'استخدام التقنيات والوسائل التعليمية المناسبة لتعزيز عملية التعلم.', weight: 10 },
            { id: 'performance_8', title: 'تهيئة البيئة التعليمية', description: 'تهيئة بيئة تعليمية محفزة وآمنة للمتعلمين.', weight: 5 },
            { id: 'performance_9', title: 'الإدارة الصفية', description: 'إدارة الصف بفاعلية وتنظيم وقت التعلم بكفاءة.', weight: 5 },
            { id: 'performance_10', title: 'تحليل نتائج المتعلمين', description: 'تحليل نتائج المتعلمين واستخدامها في تحسين الممارسات التعليمية.', weight: 10 },
            { id: 'performance_11', title: 'تنوع أساليب التقويم', description: 'استخدام أساليب تقويم متنوعة لقياس تقدم المتعلمين.', weight: 10 }
        ];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Initialize Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set up authentication listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User is signed in with UID:", userId);
                        initializeAppWithUser();
                    } else {
                        console.log("User is signed out.");
                        // Clean up listeners if user signs out
                        unsubscribeListeners.forEach(unsub => unsub());
                        unsubscribeListeners = [];
                    }
                });

                // Sign in the user
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // Setup general event listeners that don't depend on data
                setupStaticEventListeners();

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showNotification("فشل الاتصال بقاعدة البيانات", "error");
            }
        });
        
        // This function runs after a user is authenticated
        function initializeAppWithUser() {
            // Render static parts that might need re-rendering on user change
            renderPerformanceItems(); 
            
            // Setup listeners for dynamic data from Firestore
            setupFirestoreListeners();
            
            // Setup event listeners that interact with data
            setupDynamicEventListeners();
        }

        // --- Event Listeners Setup ---
        
        // Listeners that can be set up once on DOM load
        function setupStaticEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = link.getAttribute('data-tab');
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    link.classList.add('active');
                    document.getElementById(`${tabId}-content`).classList.add('active');
                });
            });

            // Modals
            document.getElementById('closeNoteModal').addEventListener('click', () => document.getElementById('noteModal').style.display = 'none');
            document.getElementById('closePreviewModal').addEventListener('click', () => document.getElementById('imagePreviewModal').style.display = 'none');
            
            // Confirmation Modal Buttons
            document.getElementById('confirmNoBtn').addEventListener('click', () => {
                document.getElementById('confirmModal').style.display = 'none';
                confirmCallback = null;
            });

            document.getElementById('confirmYesBtn').addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                document.getElementById('confirmModal').style.display = 'none';
                confirmCallback = null;
            });
            
            window.addEventListener('click', (e) => {
                if (e.target === document.getElementById('imagePreviewModal')) {
                    document.getElementById('imagePreviewModal').style.display = 'none';
                }
                if (e.target === document.getElementById('noteModal')) {
                    document.getElementById('noteModal').style.display = 'none';
                }
                if (e.target === document.getElementById('confirmModal')) {
                    document.getElementById('confirmModal').style.display = 'none';
                    confirmCallback = null;
                }
            });
        }

        // Listeners for buttons that modify data (require userId)
        function setupDynamicEventListeners() {
            // --- SAVE BUTTONS ---
            document.getElementById('saveBasicDataBtn').addEventListener('click', saveBasicData);
            document.getElementById('saveCvDataBtn').addEventListener('click', saveCvData);
            document.getElementById('saveFirstFollowupBtn').addEventListener('click', () => saveDocumentation('firstFollowup'));
            document.getElementById('saveSecondFollowupBtn').addEventListener('click', () => saveDocumentation('secondFollowup'));
            document.getElementById('saveRecommendationsBtn').addEventListener('click', () => saveDocumentation('recommendations'));
            document.getElementById('saveNoteBtn').addEventListener('click', saveNote);

            // --- ADD/UPLOAD BUTTONS ---
            document.getElementById('licenseUploadBtn').addEventListener('click', () => document.getElementById('licenseUpload').click());
            document.getElementById('licenseUpload').addEventListener('change', handleLicenseUpload);
            
            document.getElementById('certificateUploadBtn').addEventListener('click', () => document.getElementById('certificateUpload').click());
            document.getElementById('certificateUpload').addEventListener('change', handleCertificateUpload);

            document.getElementById('addCourseBtn').addEventListener('click', addCourse);
            document.getElementById('addImprovementBtn').addEventListener('click', addImprovementPlan);
        }

        // --- Firestore Real-time Listeners ---
        function setupFirestoreListeners() {
            // Clean up any previous listeners
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];

            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}`);

            // Listener for the main user document (basic info, cv, documentation)
            const unsubUserDoc = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    updateHeaderInfo(data.basicInfo);
                    updateCvInputs(data.cvInfo);
                    updateLicensePreview(data.licenseImage);
                    updateDocumentationInputs(data);
                } else {
                    console.log("No user document found. A new one will be created on save.");
                    // Reset UI to default state if no data
                    updateHeaderInfo({});
                    updateCvInputs({});
                    updateLicensePreview(null);
                    updateDocumentationInputs({});
                }
            }, (error) => {
                console.error("Error listening to user document:", error);
                showNotification("خطأ في تحديث البيانات", "error");
            });
            unsubscribeListeners.push(unsubUserDoc);

            // Listener for certificates subcollection
            const certsColRef = collection(userDocRef, "certificates");
            const unsubCerts = onSnapshot(certsColRef, (querySnapshot) => {
                const certificates = [];
                querySnapshot.forEach((doc) => {
                    certificates.push({ id: doc.id, ...doc.data() });
                });
                renderCertificates(certificates);
            }, (error) => console.error("Error listening to certificates:", error));
            unsubscribeListeners.push(unsubCerts);

            // Listener for courses subcollection
            const coursesColRef = collection(userDocRef, "courses");
            const unsubCourses = onSnapshot(coursesColRef, (querySnapshot) => {
                const courses = [];
                querySnapshot.forEach((doc) => {
                    courses.push({ id: doc.id, ...doc.data() });
                });
                renderCourses(courses);
            }, (error) => console.error("Error listening to courses:", error));
            unsubscribeListeners.push(unsubCourses);

            // Listener for improvements subcollection
            const improvementsColRef = collection(userDocRef, "improvements");
            const unsubImprovements = onSnapshot(improvementsColRef, (querySnapshot) => {
                const improvements = [];
                querySnapshot.forEach((doc) => {
                    improvements.push({ id: doc.id, ...doc.data() });
                });
                renderImprovementPlans(improvements);
            }, (error) => console.error("Error listening to improvements:", error));
            unsubscribeListeners.push(unsubImprovements);

            // Listener for performance data subcollection
            const performanceColRef = collection(userDocRef, "performanceData");
            const unsubPerformance = onSnapshot(performanceColRef, (querySnapshot) => {
                const performanceData = [];
                 querySnapshot.forEach((doc) => {
                    performanceData.push({ id: doc.id, ...doc.data() });
                });
                updatePerformanceUI(performanceData);
            }, (error) => console.error("Error listening to performance data:", error));
            unsubscribeListeners.push(unsubPerformance);
        }

        // --- Data Handling Functions (Read from UI, Write to DB) ---

        async function saveBasicData() {
            const data = {
                teacherName: document.getElementById('teacherNameInput').value,
                educationDept: document.getElementById('educationDeptInput').value,
                schoolName: document.getElementById('schoolNameInput').value,
                academicYear: document.getElementById('academicYearInput').value,
            };
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}`);
                await setDoc(userDocRef, { basicInfo: data }, { merge: true });
                showNotification("تم حفظ البيانات الأساسية بنجاح", "success");
            } catch (error) {
                console.error("Error saving basic data: ", error);
                showNotification("خطأ في حفظ البيانات", "error");
            }
        }

        async function saveCvData() {
            const data = {
                fullName: document.getElementById('fullNameInput').value,
                specialty: document.getElementById('specialtyInput').value,
                qualification: document.getElementById('qualificationInput').value,
                yearsOfExperience: document.getElementById('yearsOfExperienceInput').value,
            };
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}`);
                await setDoc(userDocRef, { cvInfo: data }, { merge: true });
                showNotification("تم حفظ بيانات السيرة الذاتية بنجاح", "success");
            } catch (error) {
                console.error("Error saving CV data: ", error);
                showNotification("خطأ في حفظ البيانات", "error");
            }
        }
        
        async function saveDocumentation(field) {
            let data = {};
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}`);
                if (field === 'firstFollowup') {
                    data.firstFollowup = {
                        date: document.getElementById('firstFollowupDate').value,
                        name: document.getElementById('firstFollowupName').value,
                        notes: document.getElementById('firstFollowupNotes').value,
                    };
                } else if (field === 'secondFollowup') {
                    data.secondFollowup = {
                        date: document.getElementById('secondFollowupDate').value,
                        name: document.getElementById('secondFollowupName').value,
                        notes: document.getElementById('secondFollowupNotes').value,
                    };
                } else if (field === 'recommendations') {
                    data.recommendations = document.getElementById('recommendations').value;
                }
                await setDoc(userDocRef, data, { merge: true });
                showNotification("تم حفظ بيانات التوثيق بنجاح", "success");
            } catch(e) {
                console.error("Error saving documentation:", e);
                showNotification("خطأ في حفظ البيانات", "error");
            }
        }

        function handleLicenseUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(event) {
                const base64String = event.target.result;
                try {
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}`);
                    await setDoc(userDocRef, { licenseImage: base64String }, { merge: true });
                    showNotification("تم رفع صورة الرخصة بنجاح", "success");
                } catch (error) {
                    console.error("Error uploading license: ", error);
                    showNotification("خطأ في رفع الصورة", "error");
                }
            };
            reader.readAsDataURL(file);
        }

        function handleCertificateUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const certificatesContainer = document.getElementById('certificatesContainer');
            if (certificatesContainer.querySelectorAll('.certificate-item').length -1 >= 8) {
                 showNotification('لقد وصلت للحد الأقصى من الشهادات (8 شهادات)', "error");
                 return;
            }

            const reader = new FileReader();
            reader.onload = async function(event) {
                const base64String = event.target.result;
                try {
                    const certsColRef = collection(db, `artifacts/${appId}/users/${userId}/certificates`);
                    await addDoc(certsColRef, { url: base64String, createdAt: new Date() });
                    showNotification("تم إضافة الشهادة بنجاح", "success");
                } catch (error) {
                    console.error("Error adding certificate: ", error);
                    showNotification("خطأ في إضافة الشهادة", "error");
                }
            };
            reader.readAsDataURL(file);
        }
        
        async function deleteCertificate(certId) {
            showConfirmModal("هل أنت متأكد من حذف هذه الشهادة؟", async () => {
                try {
                    const certDocRef = doc(db, `artifacts/${appId}/users/${userId}/certificates`, certId);
                    await deleteDoc(certDocRef);
                    showNotification("تم حذف الشهادة بنجاح", "success");
                } catch (error) {
                    console.error("Error deleting certificate: ", error);
                    showNotification("خطأ في حذف الشهادة", "error");
                }
            });
        }

        async function addCourse() {
            const course = {
                name: document.getElementById('courseNameInput').value,
                provider: document.getElementById('courseProviderInput').value,
                date: document.getElementById('courseDateInput').value,
                hours: document.getElementById('courseHoursInput').value,
            };

            if (!course.name || !course.provider || !course.date || !course.hours) {
                showNotification("يرجى ملء جميع حقول الدورة التدريبية", "error");
                return;
            }
            
            try {
                const coursesColRef = collection(db, `artifacts/${appId}/users/${userId}/courses`);
                await addDoc(coursesColRef, { ...course, createdAt: new Date() });
                showNotification("تمت إضافة الدورة بنجاح", "success");
                // Clear inputs
                document.getElementById('courseNameInput').value = '';
                document.getElementById('courseProviderInput').value = '';
                document.getElementById('courseDateInput').value = '';
                document.getElementById('courseHoursInput').value = '';
            } catch (error) {
                console.error("Error adding course: ", error);
                showNotification("خطأ في إضافة الدورة", "error");
            }
        }
        
        async function deleteCourse(courseId) {
            showConfirmModal("هل أنت متأكد من حذف هذه الدورة؟", async () => {
                try {
                    const courseDocRef = doc(db, `artifacts/${appId}/users/${userId}/courses`, courseId);
                    await deleteDoc(courseDocRef);
                    showNotification("تم حذف الدورة بنجاح", "success");
                } catch (error) {
                    console.error("Error deleting course: ", error);
                    showNotification("خطأ في حذف الدورة", "error");
                }
            });
        }

        async function addImprovementPlan() {
            const plan = {
                area: document.getElementById('improvementArea').value,
                priority: document.getElementById('improvementPriority').value,
                goal: document.getElementById('improvementGoal').value,
                actions: document.getElementById('improvementActions').value,
                startDate: document.getElementById('improvementStartDate').value,
                endDate: document.getElementById('improvementEndDate').value,
            };

            if (!plan.area || !plan.priority || !plan.goal || !plan.actions || !plan.startDate || !plan.endDate) {
                showNotification("يرجى ملء جميع حقول خطة التحسين", "error");
                return;
            }
            
            try {
                const improvementsColRef = collection(db, `artifacts/${appId}/users/${userId}/improvements`);
                await addDoc(improvementsColRef, { ...plan, createdAt: new Date() });
                showNotification("تمت إضافة خطة التحسين بنجاح", "success");
                 // Clear inputs
                document.getElementById('improvementArea').value = '';
                document.getElementById('improvementPriority').value = '';
                document.getElementById('improvementGoal').value = '';
                document.getElementById('improvementActions').value = '';
                document.getElementById('improvementStartDate').value = '';
                document.getElementById('improvementEndDate').value = '';
            } catch(error) {
                console.error("Error adding improvement plan:", error);
                showNotification("خطأ في إضافة الخطة", "error");
            }
        }
        
        async function deleteImprovement(improvementId) {
            showConfirmModal("هل أنت متأكد من حذف هذه الخطة؟", async () => {
                try {
                    const improvementDocRef = doc(db, `artifacts/${appId}/users/${userId}/improvements`, improvementId);
                    await deleteDoc(improvementDocRef);
                    showNotification("تم حذف الخطة بنجاح", "success");
                } catch (error) {
                    console.error("Error deleting improvement plan:", error);
                    showNotification("خطأ في حذف الخطة", "error");
                }
            });
        }

        async function updatePerformanceRating(performanceId, rating) {
            try {
                const perfDocRef = doc(db, `artifacts/${appId}/users/${userId}/performanceData`, performanceId);
                await setDoc(perfDocRef, { rating: rating }, { merge: true });
                // No notification here to avoid spamming on slider move
            } catch (error) {
                console.error("Error updating rating:", error);
                showNotification("خطأ في تحديث التقييم", "error");
            }
        }

        async function saveNote() {
            if (!currentNoteItemId) return;
            const note = document.getElementById('noteText').value;
            try {
                const perfDocRef = doc(db, `artifacts/${appId}/users/${userId}/performanceData`, currentNoteItemId);
                await setDoc(perfDocRef, { note: note }, { merge: true });
                showNotification("تم حفظ الملاحظة بنجاح", "success");
                document.getElementById('noteModal').style.display = 'none';
                currentNoteItemId = null;
            } catch (error) {
                console.error("Error saving note:", error);
                showNotification("خطأ في حفظ الملاحظة", "error");
            }
        }

        function handlePerformanceFileUpload(file, performanceId) {
            const reader = new FileReader();
            reader.onload = async function(event) {
                const fileData = {
                    name: file.name,
                    type: file.type,
                    url: event.target.result // base64
                };
                 try {
                    const perfDocRef = doc(db, `artifacts/${appId}/users/${userId}/performanceData`, performanceId);
                    // To add to an array, we need to read first, then write.
                    const docSnap = await getDoc(perfDocRef);
                    const existingFiles = docSnap.exists() && docSnap.data().files ? docSnap.data().files : [];
                    if (existingFiles.length >= 4) {
                        showNotification('لقد وصلت للحد الأقصى من الملفات (4 ملفات)', 'error');
                        return;
                    }
                    existingFiles.push(fileData);
                    await setDoc(perfDocRef, { files: existingFiles }, { merge: true });
                    showNotification("تم رفع الشاهد بنجاح", "success");
                } catch (error) {
                    console.error("Error uploading performance file:", error);
                    showNotification("خطأ في رفع الملف", "error");
                }
            };
            reader.readAsDataURL(file);
        }

        async function deletePerformanceFile(performanceId, fileUrl) {
            showConfirmModal("هل أنت متأكد من حذف هذا الشاهد؟", async () => {
                try {
                    const perfDocRef = doc(db, `artifacts/${appId}/users/${userId}/performanceData`, performanceId);
                    const docSnap = await getDoc(perfDocRef);
                    if (docSnap.exists()) {
                        const existingFiles = docSnap.data().files || [];
                        const updatedFiles = existingFiles.filter(f => f.url !== fileUrl);
                        await updateDoc(perfDocRef, { files: updatedFiles });
                        showNotification("تم حذف الشاهد بنجاح", "success");
                    }
                } catch (error) {
                    console.error("Error deleting performance file:", error);
                    showNotification("خطأ في حذف الملف", "error");
                }
            });
        }

        // --- UI Rendering Functions (Read from DB, Write to UI) ---

        function updateHeaderInfo(basicInfo = {}) {
            document.getElementById('teacherName').textContent = 'اسم المعلم: ' + (basicInfo.teacherName || '-');
            document.getElementById('educationDept').textContent = 'الإدارة التعليمية: ' + (basicInfo.educationDept || '-');
            document.getElementById('schoolName').textContent = 'المدرسة: ' + (basicInfo.schoolName || '-');
            document.getElementById('academicYear').textContent = 'العام الدراسي: ' + (basicInfo.academicYear || '-');
            
            document.getElementById('teacherNameInput').value = basicInfo.teacherName || '';
            document.getElementById('educationDeptInput').value = basicInfo.educationDept || '';
            document.getElementById('schoolNameInput').value = basicInfo.schoolName || '';
            document.getElementById('academicYearInput').value = basicInfo.academicYear || '';
        }

        function updateCvInputs(cvInfo = {}) {
            document.getElementById('fullNameInput').value = cvInfo.fullName || '';
            document.getElementById('specialtyInput').value = cvInfo.specialty || '';
            document.getElementById('qualificationInput').value = cvInfo.qualification || '';
            document.getElementById('yearsOfExperienceInput').value = cvInfo.yearsOfExperience || '';
        }

        function updateLicensePreview(licenseImage) {
            const licensePreview = document.getElementById('licensePreview');
            if (licenseImage) {
                licensePreview.innerHTML = `<img src="${licenseImage}" alt="الرخصة المهنية">`;
            } else {
                licensePreview.innerHTML = '<div class="certificate-placeholder">+</div>';
            }
        }
        
        function updateDocumentationInputs(docData = {}) {
            const firstFollowup = docData.firstFollowup || {};
            document.getElementById('firstFollowupDate').value = firstFollowup.date || '';
            document.getElementById('firstFollowupName').value = firstFollowup.name || '';
            document.getElementById('firstFollowupNotes').value = firstFollowup.notes || '';

            const secondFollowup = docData.secondFollowup || {};
            document.getElementById('secondFollowupDate').value = secondFollowup.date || '';
            document.getElementById('secondFollowupName').value = secondFollowup.name || '';
            document.getElementById('secondFollowupNotes').value = secondFollowup.notes || '';
            
            document.getElementById('recommendations').value = docData.recommendations || '';
        }
        
        function renderCertificates(certificates = []) {
            const container = document.getElementById('certificatesContainer');
            container.innerHTML = ''; // Clear
            
            certificates.forEach(cert => {
                const certItem = document.createElement('div');
                certItem.className = 'certificate-item';
                certItem.innerHTML = `<img src="${cert.url}" alt="شهادة">`;
                certItem.addEventListener('click', () => {
                    document.getElementById('previewImage').src = cert.url;
                    document.getElementById('imagePreviewModal').style.display = 'block';
                });
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.style.position = 'absolute';
                deleteBtn.style.top = '5px';
                deleteBtn.style.right = '5px';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.onclick = (e) => { e.stopPropagation(); deleteCertificate(cert.id); };
                certItem.appendChild(deleteBtn);
                container.appendChild(certItem);
            });

            if (certificates.length < 8) {
                const addItem = document.createElement('div');
                addItem.className = 'certificate-item certificate-add';
                addItem.innerHTML = '<div class="certificate-placeholder">+</div>';
                addItem.onclick = () => document.getElementById('certificateUpload').click();
                container.appendChild(addItem);
            }
        }

        function renderCourses(courses = []) {
            const list = document.getElementById('coursesList');
            list.innerHTML = '';
            courses.forEach(course => {
                const item = document.createElement('div');
                item.className = 'course-item';
                item.innerHTML = `
                    <div>
                        <strong>${course.name}</strong>
                        <p>الجهة: ${course.provider} | التاريخ: ${formatDate(course.date)} | عدد الساعات: ${course.hours}</p>
                    </div>
                    <button class="delete-btn" data-id="${course.id}">حذف</button>
                `;
                item.querySelector('.delete-btn').onclick = () => deleteCourse(course.id);
                list.appendChild(item);
            });
        }
        
        function renderImprovementPlans(improvements = []) {
            const list = document.getElementById('improvementList');
            list.innerHTML = '';
            improvements.forEach(plan => {
                const priorityClass = plan.priority === 'عالية' ? 'priority-high' : plan.priority === 'متوسطة' ? 'priority-medium' : 'priority-low';
                const item = document.createElement('div');
                item.className = 'improvement-item';
                item.innerHTML = `
                    <h4>${plan.area}</h4>
                    <p><strong>الأولوية:</strong> <span class="${priorityClass}">${plan.priority}</span></p>
                    <p><strong>الهدف:</strong> ${plan.goal}</p>
                    <p><strong>الإجراءات المقترحة:</strong> ${plan.actions}</p>
                    <p><strong>الفترة الزمنية:</strong> ${formatDate(plan.startDate)} إلى ${formatDate(plan.endDate)}</p>
                    <button class="delete-btn" data-id="${plan.id}">حذف</button>
                `;
                item.querySelector('.delete-btn').onclick = () => deleteImprovement(plan.id);
                list.appendChild(item);
            });
        }
        
        // This renders the static structure of performance items
        function renderPerformanceItems() {
            const container = document.getElementById('performanceItems');
            container.innerHTML = '';
            performanceIndicators.forEach(indicator => {
                const itemElement = document.createElement('div');
                itemElement.className = 'performance-item';
                itemElement.id = indicator.id;
                itemElement.innerHTML = `
                    <div class="performance-header">
                        <h3 class="performance-title">${indicator.title} (${indicator.weight}%)</h3>
                        <button class="note-btn" data-id="${indicator.id}">
                            <i class="fas fa-sticky-note note-icon"></i>
                        </button>
                    </div>
                    <p class="performance-description">${indicator.description}</p>
                    <div class="performance-uploads">
                        <label>الشواهد (الحد الأقصى 4 ملفات)</label>
                        <div class="upload-container" id="uploads_${indicator.id}">
                            <div class="upload-item upload-add" data-id="${indicator.id}">
                                <div class="upload-placeholder">+</div>
                            </div>
                        </div>
                    </div>
                    <div class="performance-rating">
                        <label>التقييم الذاتي</label>
                        <div class="rating-container">
                            <span class="rating-value">0</span>
                            <div class="rating-slider-container">
                                <input type="range" min="0" max="5" step="1" value="0" class="rating-slider" data-id="${indicator.id}">
                                <div class="rating-numbers">
                                    ${[0,1,2,3,4,5].map(n => `<span class="rating-number ${n === 0 ? 'active' : ''}" data-value="${n}">${n}</span>`).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="performance-note">
                        <label>الملاحظات</label>
                        <textarea readonly placeholder="افتح الملاحظات للتعديل"></textarea>
                    </div>`;
                container.appendChild(itemElement);
            });
            addPerformanceEventListeners();
        }

        // This updates the dynamic parts of performance items with data
        function updatePerformanceUI(performanceData = []) {
            performanceIndicators.forEach(indicator => {
                const data = performanceData.find(item => item.id === indicator.id) || {};
                const itemElement = document.getElementById(indicator.id);
                if (!itemElement) return;

                // Update rating
                const rating = data.rating || 0;
                itemElement.querySelector('.rating-value').textContent = rating;
                itemElement.querySelector('.rating-slider').value = rating;
                itemElement.querySelectorAll('.rating-number').forEach(num => {
                    num.classList.toggle('active', parseInt(num.dataset.value) === rating);
                });

                // Update note
                const noteTextarea = itemElement.querySelector('.performance-note textarea');
                noteTextarea.value = data.note || '';
                itemElement.querySelector('.performance-note').style.display = data.note ? 'block' : 'none';

                // Update files
                const uploadContainer = itemElement.querySelector('.upload-container');
                // Clear previous files except the add button
                uploadContainer.querySelectorAll('.upload-item:not(.upload-add)').forEach(el => el.remove());
                const files = data.files || [];
                files.forEach(file => {
                    const fileElement = createFileElement(file, indicator.id);
                    uploadContainer.insertBefore(fileElement, uploadContainer.lastChild);
                });
            });
            calculateTotalScore(performanceData);
        }
        
        function createFileElement(file, performanceId) {
            const fileElement = document.createElement('div');
            fileElement.className = 'upload-item';
            
            if (file.type && file.type.startsWith('image/')) {
                fileElement.innerHTML = `<img src="${file.url}" alt="شاهد">`;
                fileElement.onclick = () => {
                    document.getElementById('previewImage').src = file.url;
                    document.getElementById('imagePreviewModal').style.display = 'block';
                };
            } else {
                fileElement.innerHTML = `<div class="upload-file-icon"><i class="fas fa-file-pdf"></i></div>`;
                fileElement.onclick = () => window.open(file.url, '_blank');
            }
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.style.position = 'absolute';
            deleteBtn.style.top = '5px';
            deleteBtn.style.right = '5px';
            deleteBtn.innerHTML = '&times;';
            deleteBtn.onclick = (e) => { e.stopPropagation(); deletePerformanceFile(performanceId, file.url); };
            fileElement.appendChild(deleteBtn);
            return fileElement;
        }

        function addPerformanceEventListeners() {
            document.querySelectorAll('.note-btn').forEach(btn => {
                btn.onclick = () => {
                    currentNoteItemId = btn.dataset.id;
                    const itemData = document.getElementById(currentNoteItemId);
                    const note = itemData.querySelector('.performance-note textarea').value;
                    document.getElementById('noteText').value = note;
                    document.getElementById('noteModal').style.display = 'block';
                };
            });

            document.querySelectorAll('.rating-slider').forEach(slider => {
                slider.oninput = () => {
                    const value = parseInt(slider.value);
                    const container = slider.closest('.performance-rating');
                    container.querySelector('.rating-value').textContent = value;
                    container.querySelectorAll('.rating-number').forEach(num => {
                        num.classList.toggle('active', parseInt(num.dataset.value) === value);
                    });
                    updatePerformanceRating(slider.dataset.id, value);
                };
            });
            
            document.querySelectorAll('.rating-number').forEach(number => {
                number.onclick = () => {
                    const value = parseInt(number.dataset.value);
                    const container = number.closest('.performance-rating');
                    container.querySelector('.rating-slider').value = value;
                    container.querySelector('.rating-value').textContent = value;
                    container.querySelectorAll('.rating-number').forEach(num => num.classList.remove('active'));
                    number.classList.add('active');
                    updatePerformanceRating(container.querySelector('.rating-slider').dataset.id, value);
                };
            });

            document.querySelectorAll('.upload-add').forEach(btn => {
                btn.onclick = () => {
                    const performanceId = btn.dataset.id;
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = 'image/*,application/pdf';
                    fileInput.style.display = 'none';
                    fileInput.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file) handlePerformanceFileUpload(file, performanceId);
                        document.body.removeChild(fileInput);
                    };
                    document.body.appendChild(fileInput);
                    fileInput.click();
                };
            });
        }
        
        // --- Helper & Utility Functions ---
        
        function calculateTotalScore(performanceData = []) {
            let totalWeightedScore = 0;
            let totalWeight = 0;
            let detailsHTML = '';
            
            performanceIndicators.forEach(indicator => {
                const data = performanceData.find(item => item.id === indicator.id);
                const rating = data ? data.rating || 0 : 0;
                const weightedScore = (rating / 5) * indicator.weight;
                
                totalWeightedScore += weightedScore;
                totalWeight += indicator.weight;
                
                detailsHTML += `<p>${indicator.title}: <span>${rating} من 5</span> <span>(${weightedScore.toFixed(1)}%)</span></p>`;
            });
            
            const finalScore = totalWeight > 0 ? totalWeightedScore : 0; // The score is already a percentage of 100
            
            document.getElementById('totalScore').textContent = `${finalScore.toFixed(1)}%`;
            document.getElementById('scoreDetails').innerHTML = detailsHTML;
        }

        function showNotification(message, type = "success") {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showConfirmModal(text, callback) {
            document.getElementById('confirmText').textContent = text;
            confirmCallback = callback;
            document.getElementById('confirmModal').style.display = 'block';
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            // Add a day to the date to fix potential timezone issues with input[type=date]
            const date = new Date(dateString);
            date.setDate(date.getDate() + 1);
            return date.toLocaleDateString('ar-SA', options);
        }

    </script>
</body>
</html>
