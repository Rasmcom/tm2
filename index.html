<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ملف شواهد الأداء الوظيفي للمعلم</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ... نفس كود CSS الذي أرفقته ... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* Header Styles - UPDATED */
        header {
            background-color: #333;
            padding: 15px 0;
            position: relative;
        }
        
        .header-gradient {
            height: 4px;
            background: linear-gradient(to left, #4CAF50, #2196F3);
            margin-top: 5px;
        }
        
        .header-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .header-top {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            margin: 0 auto;
        }
        
        .logo {
            width: 60px;
            height: auto;
            margin-left: 15px;
        }
        
        .site-title {
            color: white;
            font-size: 20px;
            font-weight: 700;
        }
        
        .header-info {
            color: white;
            font-size: 14px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            width: 100%;
        }
        
        .header-info p {
            margin: 0 10px;
        }
        
        /* Layout */
        .main-layout {
            display: flex;
            min-height: calc(100vh - 200px); /* Adjust for header and footer */
        }
        
        /* Sidebar Navigation */
        .sidebar {
            width: 80px;
            background-color: #333;
            position: sticky;
            top: 0;
            height: 100vh;
            transition: width 0.3s;
            overflow: hidden;
            z-index: 100;
        }
        
        .sidebar:hover {
            width: 220px;
        }
        
        .nav-list {
            list-style: none;
            padding: 20px 0;
        }
        
        .nav-item {
            margin-bottom: 5px;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: white;
            text-decoration: none;
            white-space: nowrap;
            transition: background-color 0.3s;
        }
        
        .nav-link:hover, .nav-link.active {
            background-color: #4CAF50;
        }
        
        .nav-icon {
            font-size: 20px;
            min-width: 50px;
            text-align: center;
        }
        
        .nav-text {
            margin-right: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .sidebar:hover .nav-text {
            opacity: 1;
        }
        
        /* Content Area */
        .content-area {
            flex: 1;
            padding: 20px;
            transition: margin-right 0.3s;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
            padding: 20px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            min-height: 400px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background-color: #0b7dda;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 5px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #777;
        }
        
        /* Footer Styles */
        footer {
            background-color: #333;
            color: white;
            padding: 20px 0;
            text-align: center;
            margin-top: 30px;
        }
        
        .footer-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .footer-logo {
            width: 40px;
            height: auto;
        }
        
        .footer-link {
            color: #2196F3;
            text-decoration: none;
        }
        
        /* Introduction Page - Enhanced Design */
        .intro-section {
            margin-bottom: 40px;
            position: relative;
            padding: 25px;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .intro-section::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(to bottom, #4CAF50, #2196F3);
        }
        
        .intro-section h2 {
            color: #2196F3;
            margin-bottom: 20px;
            font-size: 24px;
            position: relative;
            padding-bottom: 10px;
        }
        
        .intro-section h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 60px;
            height: 3px;
            background-color: #4CAF50;
        }
        
        .intro-section p {
            line-height: 1.8;
            margin-bottom: 15px;
            font-size: 16px;
            text-align: justify;
        }
        
        .vision-mission-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 30px;
        }
        
        .vision-box, .mission-box {
            flex: 1;
            min-width: 300px;
            padding: 25px;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .vision-box:hover, .mission-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .vision-box {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            border-top: 4px solid #2196F3;
        }
        
        .mission-box {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            border-top: 4px solid #4CAF50;
        }
        
        .vision-box h2, .mission-box h2 {
            font-size: 22px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .vision-box h2 {
            color: #2196F3;
        }
        
        .mission-box h2 {
            color: #4CAF50;
        }
        
        .vision-box h2 i, .mission-box h2 i {
            margin-left: 10px;
            font-size: 24px;
        }
        
        .vision-box p, .mission-box p {
            line-height: 1.8;
            text-align: justify;
        }
        
        .values-container {
            margin-top: 40px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .values-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, #4CAF50, #2196F3);
        }
        
        .values-container h2 {
            color: #333;
            margin-bottom: 25px;
            text-align: center;
            font-size: 24px;
        }
        
        .values-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .value-item {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            align-items: flex-start;
        }
        
        .value-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .value-icon {
            width: 40px;
            height: 40px;
            background-color: #e8f5e9;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            flex-shrink: 0;
        }
        
        .value-icon i {
            color: #4CAF50;
            font-size: 18px;
        }
        
        .value-content h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #333;
        }
        
        .value-content p {
            color: #666;
            line-height: 1.6;
            font-size: 14px;
        }
        
        /* Leaders Words Page - Enhanced Design */
        .leaders-header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
            padding-bottom: 15px;
        }
        
        .leaders-header h2 {
            font-size: 28px;
            color: #333;
        }
        
        .leaders-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background: linear-gradient(to right, #4CAF50, #2196F3);
        }
        
        .leaders-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
        }
        
        .leader-card {
            width: 100%;
            max-width: 350px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            background-color: #fff;
            position: relative;
        }
        
        .leader-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .leader-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, #4CAF50, #2196F3);
        }
        
        .leader-image-container {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 5px solid #fff;
            overflow: hidden;
            margin: 30px auto 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .leader-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }
        
        .leader-card:hover .leader-image {
            transform: scale(1.1);
        }
        
        .leader-content {
            padding: 20px 25px 30px;
            text-align: center;
        }
        
        .leader-content h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 18px;
            line-height: 1.4;
            position: relative;
            padding-bottom: 15px;
        }
        
        .leader-content h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 2px;
            background-color: #4CAF50;
        }
        
        .leader-content p {
            line-height: 1.8;
            text-align: justify;
            color: #555;
            font-size: 15px;
            position: relative;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .leader-content p::before {
            content: '\201C';
            font-size: 60px;
            position: absolute;
            top: -15px;
            right: 10px;
            color: #e0e0e0;
            font-family: serif;
        }
        
        /* CV Page */
        .cv-section {
            margin-bottom: 30px;
        }
        
        .cv-section h3 {
            color: #2196F3;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        
        .certificate-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        
        .certificate-item {
            width: 150px;
            height: 150px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }
        
        .certificate-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .certificate-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            background-color: #f5f5f5;
            color: #777;
            font-size: 40px;
        }
        
        .courses-list {
            margin-top: 15px;
        }
        
        .course-item {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .delete-btn {
            background-color: #ff5252;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        /* Performance Indicators Page */
        .performance-item {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .performance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .performance-title {
            font-size: 18px;
            font-weight: 700;
        }
        
        .performance-description {
            margin-bottom: 15px;
            color: #555;
        }
        
        .performance-uploads {
            margin-bottom: 15px;
        }
        
        .upload-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .upload-item {
            width: 100px;
            height: 100px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }
        
        .upload-item img, .upload-item iframe {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .upload-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            background-color: #f5f5f5;
            color: #777;
            font-size: 30px;
        }
        
        .upload-file-icon {
            font-size: 40px;
            color: #2196F3;
        }
        
        .performance-rating {
            margin-top: 15px;
        }
        
        .rating-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* New Rating Slider Style */
        .rating-slider-container {
            width: 100%;
            max-width: 300px;
            margin-top: 10px;
        }
        
        .rating-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e0e0e0;
            outline: none;
            margin-bottom: 10px;
        }
        
        .rating-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2196F3;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .rating-slider::-webkit-slider-thumb:hover {
            background: #0b7dda;
            transform: scale(1.2);
        }
        
        .rating-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2196F3;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }
        
        .rating-slider::-moz-range-thumb:hover {
            background: #0b7dda;
            transform: scale(1.2);
        }
        
        .rating-numbers {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }
        
        .rating-number {
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .rating-number.active {
            background-color: #2196F3;
            color: white;
        }
        
        .rating-value {
            font-size: 16px;
            font-weight: bold;
            color: #2196F3;
            margin-right: 10px;
        }
        
        .note-btn {
            background-color: #f0f0f0;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .note-btn:hover {
            background-color: #e0e0e0;
        }
        
        .note-icon {
            font-size: 20px;
            color: #555;
        }
        
        .performance-note {
            margin-top: 15px;
            display: none;
        }
        
        .performance-note textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
            min-height: 80px;
        }
        
        .performance-result {
            margin-top: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .performance-result::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, #4CAF50, #2196F3);
        }
        
        .result-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
        }
        
        .result-score {
            font-size: 48px;
            font-weight: 700;
            color: #4CAF50;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .result-details {
            margin-top: 20px;
            text-align: right;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .result-details p {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed #e0e0e0;
        }
        
        .result-details p:last-child {
            border-bottom: none;
        }
        
        /* Documentation Page */
        .documentation-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .documentation-section h3 {
            color: #2196F3;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        
        /* Improvement Plan Page */
        .improvement-section {
            margin-bottom: 30px;
        }
        
        .improvement-form {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .improvement-list {
            margin-top: 20px;
        }
        
        .improvement-item {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .improvement-item h4 {
            margin-bottom: 10px;
            color: #2196F3;
        }
        
        .priority-high {
            color: #ff5252;
            font-weight: 600;
        }
        
        .priority-medium {
            color: #FFA726;
            font-weight: 600;
        }
        
        .priority-low {
            color: #4CAF50;
            font-weight: 600;
        }
        
        /* Image Preview Modal */
        .image-preview-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
        }
        
        .image-preview-content {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
        }
        
        .preview-image {
            max-width: 90%;
            max-height: 90%;
        }
        
        .close-preview {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 30px;
            color: white;
            cursor: pointer;
        }
        
        /* Performance Item Colors */
        .performance-item:nth-child(1) { border-top: 4px solid #FF5252; }
        .performance-item:nth-child(2) { border-top: 4px solid #FF9800; }
        .performance-item:nth-child(3) { border-top: 4px solid #FFEB3B; }
        .performance-item:nth-child(4) { border-top: 4px solid #4CAF50; }
        .performance-item:nth-child(5) { border-top: 4px solid #2196F3; }
        .performance-item:nth-child(6) { border-top: 4px solid #673AB7; }
        .performance-item:nth-child(7) { border-top: 4px solid #9C27B0; }
        .performance-item:nth-child(8) { border-top: 4px solid #E91E63; }
        .performance-item:nth-child(9) { border-top: 4px solid #795548; }
        .performance-item:nth-child(10) { border-top: 4px solid #607D8B; }
        .performance-item:nth-child(11) { border-top: 4px solid #009688; }
        
        /* Responsive Styles - FIXED FOR MOBILE */
        @media (max-width: 768px) {
            .header-top {
                flex-direction: column;
                text-align: center;
            }
            
            .logo-container {
                margin-bottom: 10px;
                margin-left: 0;
            }
            
            .header-info {
                text-align: center;
                margin-bottom: 10px;
                flex-direction: column;
                gap: 5px;
            }
            
            .main-layout {
                flex-direction: row; /* Keep as row instead of column */
            }
            
            .sidebar {
                width: 60px; /* Smaller width on mobile */
                height: 100vh;
                position: fixed; /* Fixed position */
                top: 0;
                right: 0;
                z-index: 100;
            }
            
            .sidebar:hover {
                width: 180px; /* Smaller expanded width on mobile */
            }
            
            .nav-list {
                display: flex;
                flex-direction: column; /* Keep as column */
                padding: 10px 0;
            }
            
            .nav-item {
                margin: 5px 0;
            }
            
            .nav-link {
                padding: 10px;
            }
            
            .nav-icon {
                min-width: 40px;
                font-size: 18px;
            }
            
            .content-area {
                margin-right: 60px; /* Add margin to account for sidebar */
                width: calc(100% - 60px);
                padding: 15px;
            }
            
            .leader-card {
                max-width: 100%;
            }
            
            .vision-mission-container {
                flex-direction: column;
            }
            
            .values-grid {
                grid-template-columns: 1fr;
            }
            
            /* Adjust modal for mobile */
            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 15px;
            }
            
            /* Adjust form elements for mobile */
            .form-control, .btn {
                font-size: 14px;
                padding: 8px 15px;
            }
            
            /* Make sure the sidebar is always visible */
            .sidebar {
                display: block !important;
            }
        }
        
        /* For very small screens */
        @media (max-width: 480px) {
            .sidebar {
                width: 50px;
            }
            
            .content-area {
                margin-right: 50px;
                width: calc(100% - 50px);
                padding: 10px;
            }
            
            .nav-icon {
                min-width: 30px;
                font-size: 16px;
            }
            
            .site-title {
                font-size: 16px;
            }
            
            .header-info {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="header-top">
                    <div class="logo-container">
                        <img src="https://salogos.org/wp-content/uploads/2021/11/UntiTtled-1-1300x988.png" alt="شعار وزارة التعليم" class="logo">
                        <h1 class="site-title">ملف شواهد الأداء الوظيفي للمعلم</h1>
                    </div>
                </div>
                <div class="header-info" id="headerInfo">
                    <p id="teacherName">اسم المعلم: -</p>
                    <p id="educationDept">الإدارة التعليمية: -</p>
                    <p id="schoolName">المدرسة: -</p>
                    <p id="academicYear">العام الدراسي: -</p>
                </div>
            </div>
        </div>
        <div class="header-gradient"></div>
    </header>
    
    <div class="main-layout">
        <div class="sidebar">
            <ul class="nav-list">
                <li class="nav-item"><a href="#" class="nav-link active" data-tab="home"><i class="fas fa-home nav-icon"></i> <span class="nav-text">الرئيسية</span></a></li>
                <li class="nav-item"><a href="#" class="nav-link" data-tab="intro"><i class="fas fa-info-circle nav-icon"></i> <span class="nav-text">مقدمة الملف</span></a></li>
                <li class="nav-item"><a href="#" class="nav-link" data-tab="leaders"><i class="fas fa-quote-right nav-icon"></i> <span class="nav-text">كلمات القادة</span></a></li>
                <li class="nav-item"><a href="#" class="nav-link" data-tab="cv"><i class="fas fa-user-tie nav-icon"></i> <span class="nav-text">السيرة الذاتية</span></a></li>
                <li class="nav-item"><a href="#" class="nav-link" data-tab="performance"><i class="fas fa-chart-line nav-icon"></i> <span class="nav-text">شواهد الأداء</span></a></li>
                <li class="nav-item"><a href="#" class="nav-link" data-tab="documentation"><i class="fas fa-clipboard-check nav-icon"></i> <span class="nav-text">التوثيق والمتابعة</span></a></li>
                <li class="nav-item"><a href="#" class="nav-link" data-tab="improvement"><i class="fas fa-tasks nav-icon"></i> <span class="nav-text">خطة التحسين</span></a></li>
            </ul>
        </div>
        
        <div class="content-area">
            <div class="tab-content active" id="home-content">
                <h2>البيانات الأساسية</h2>
                <div class="form-group"><label for="teacherNameInput">اسم المعلم</label><input type="text" id="teacherNameInput" class="form-control" placeholder="أدخل اسم المعلم"></div>
                <div class="form-group"><label for="educationDeptInput">الإدارة التعليمية</label><input type="text" id="educationDeptInput" class="form-control" placeholder="أدخل اسم الإدارة التعليمية"></div>
                <div class="form-group"><label for="schoolNameInput">المدرسة</label><input type="text" id="schoolNameInput" class="form-control" placeholder="أدخل اسم المدرسة"></div>
                <div class="form-group"><label for="academicYearInput">العام الدراسي</label><input type="text" id="academicYearInput" class="form-control" placeholder="أدخل العام الدراسي"></div>
                <button class="btn" id="saveBasicDataBtn">حفظ البيانات</button>
            </div>
            
            <div class="tab-content" id="intro-content">
                <div class="intro-section">
                    <h2>مقدمة ملف شواهد الأداء الوظيفي للمعلم</h2>
                    <p>إن التعليم هو الأساس الذي تُبنى عليه الأوطان، والركيزة التي تقوم عليها النهضة الحضارية والتنموية في أي مجتمع. وقد أولت المملكة العربية السعودية، في ظل قيادتها الرشيدة، التعليم أهمية كبرى بوصفه محركًا أساسيًا لرؤية المملكة 2030 وأداة فاعلة لبناء الإنسان وتمكينه من مهارات القرن الحادي والعشرين.</p>
                </div>
                <div class="vision-mission-container">
                    <div class="vision-box"><h2><i class="fas fa-eye"></i> الرؤية</h2><p>تحقيق تعليم نوعي عالي الجودة، يُسهم في بناء جيل واعٍ ومتمكن، منافس عالميًا، ومؤمن بقيمه الوطنية.</p></div>
                    <div class="mission-box"><h2><i class="fas fa-bullseye"></i> الرسالة</h2><p>تقديم تعليم محفّز على الإبداع والتميّز، قائم على معايير مهنية، يعزز من دور المعلم في قيادة التعلم، ويركز على تمكين المتعلم من المهارات والمعارف اللازمة لمواكبة التغيرات العالمية.</p></div>
                </div>
            </div>

            <div class="tab-content" id="leaders-content">
                <div class="leaders-header"><h2>كلمات القادة</h2></div>
                <div class="leaders-container">
                    <div class="leader-card">
                        <div class="leader-image-container"><img src="https://i.top4top.io/p_3485a0uv82.jpeg" alt="الملك سلمان بن عبدالعزيز" class="leader-image"></div>
                        <div class="leader-content"><h3>كلمة خادم الحرمين الشريفين الملك سلمان بن عبدالعزيز آل سعود – حفظه الله</h3><p>"إن التعليم في السعودية هو الركيزة الأساسية للتنمية، ونحن نولي أبناءنا الطلاب والطالبات جلّ اهتمامنا، ونوفر لهم أفضل سبل التعليم الحديث، فهم عماد المستقبل وأمله."</p></div>
                    </div>
                    <div class="leader-card">
                        <div class="leader-image-container"><img src="https://h.top4top.io/p_3485vnxie0.jpeg" alt="الأمير محمد بن سلمان" class="leader-image"></div>
                        <div class="leader-content"><h3>كلمة صاحب السمو الملكي الأمير محمد بن سلمان بن عبدالعزيز – ولي العهد رئيس مجلس الوزراء – حفظه الله</h3><p>"طموحنا أن نبني وطنًا أكثر ازدهارًا، يجد فيه كل مواطن ما يتمناه، ويشارك في بناء مستقبله. ولن يكون ذلك إلا بتعليم رائد يصنع جيلاً واعيًا ومؤهلاً للمنافسة عالميًا."</p></div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="cv-content">
                <h2>السيرة الذاتية</h2>
                <div class="cv-section">
                    <h3>البيانات الأساسية</h3>
                    <div class="form-group"><label for="fullNameInput">الاسم الكامل</label><input type="text" id="fullNameInput" class="form-control" placeholder="أدخل الاسم الكامل"></div>
                    <div class="form-group"><label for="specialtyInput">التخصص</label><input type="text" id="specialtyInput" class="form-control" placeholder="أدخل التخصص"></div>
                    <div class="form-group"><label for="qualificationInput">المؤهل العلمي</label><input type="text" id="qualificationInput" class="form-control" placeholder="أدخل المؤهل العلمي"></div>
                    <div class="form-group"><label for="yearsOfExperienceInput">سنوات الخبرة</label><input type="number" id="yearsOfExperienceInput" class="form-control" placeholder="أدخل عدد سنوات الخبرة"></div>
                    <button class="btn" id="saveCvDataBtn">حفظ البيانات</button>
                </div>
                <div class="cv-section">
                    <h3>الرخصة المهنية</h3>
                    <div class="form-group"><label for="licenseUpload">رفع صورة الرخصة المهنية</label><input type="file" id="licenseUpload" accept="image/*" style="display: none;"><button class="btn" onclick="document.getElementById('licenseUpload').click()">اختر صورة الرخصة</button></div>
                    <div class="certificate-container"><div class="certificate-item" id="licensePreview"><div class="certificate-placeholder">+</div></div></div>
                </div>
                <div class="cv-section">
                    <h3>شهادات الشكر والتقدير</h3>
                    <div class="form-group"><label for="certificateUpload">رفع شهادات الشكر والتقدير (الحد الأقصى 8 شهادات)</label><input type="file" id="certificateUpload" accept="image/*" style="display: none;"><button class="btn" id="certificateUploadBtn">اختر شهادة</button></div>
                    <div class="certificate-container" id="certificatesContainer"></div>
                </div>
                <div class="cv-section">
                    <h3>الدورات التدريبية</h3>
                    <div class="form-group"><label for="courseNameInput">اسم الدورة</label><input type="text" id="courseNameInput" class="form-control" placeholder="أدخل اسم الدورة"></div>
                    <div class="form-group"><label for="courseProviderInput">الجهة المقدمة</label><input type="text" id="courseProviderInput" class="form-control" placeholder="أدخل اسم الجهة المقدمة"></div>
                    <div class="form-group"><label for="courseDateInput">تاريخ الدورة</label><input type="date" id="courseDateInput" class="form-control"></div>
                    <div class="form-group"><label for="courseHoursInput">عدد الساعات</label><input type="number" id="courseHoursInput" class="form-control" placeholder="أدخل عدد ساعات الدورة"></div>
                    <button class="btn" id="addCourseBtn">إضافة دورة</button>
                    <div class="courses-list" id="coursesList"></div>
                </div>
            </div>
            
            <div class="tab-content" id="performance-content">
                <h2>شواهد الأداء الوظيفي</h2>
                <div id="performanceItems"></div>
                <div class="performance-result">
                    <div class="result-title">نتيجة التقييم الذاتي</div>
                    <div class="result-score" id="totalScore">0%</div>
                    <div class="result-details" id="scoreDetails"></div>
                </div>
            </div>
            
            <div class="tab-content" id="documentation-content">
                 <h2>التوثيق والمتابعة</h2>
                 <div class="documentation-section">
                     <h3>المتابعة الأولى</h3>
                     <div class="form-group"><label for="firstFollowupDate">تاريخ المتابعة</label><input type="date" id="firstFollowupDate" class="form-control"></div>
                     <div class="form-group"><label for="firstFollowupName">اسم المتابع</label><input type="text" id="firstFollowupName" class="form-control" placeholder="أدخل اسم المتابع"></div>
                     <div class="form-group"><label for="firstFollowupNotes">ملاحظات المتابعة</label><textarea id="firstFollowupNotes" class="form-control" rows="4" placeholder="أدخل ملاحظات المتابعة"></textarea></div>
                     <button class="btn" id="saveFirstFollowupBtn">حفظ المتابعة الأولى</button>
                 </div>
                 <div class="documentation-section">
                     <h3>المتابعة الثانية</h3>
                     <div class="form-group"><label for="secondFollowupDate">تاريخ المتابعة</label><input type="date" id="secondFollowupDate" class="form-control"></div>
                     <div class="form-group"><label for="secondFollowupName">اسم المتابع</label><input type="text" id="secondFollowupName" class="form-control" placeholder="أدخل اسم المتابع"></div>
                     <div class="form-group"><label for="secondFollowupNotes">ملاحظات المتابعة</label><textarea id="secondFollowupNotes" class="form-control" rows="4" placeholder="أدخل ملاحظات المتابعة"></textarea></div>
                     <button class="btn" id="saveSecondFollowupBtn">حفظ المتابعة الثانية</button>
                 </div>
                 <div class="documentation-section">
                     <h3>التوصيات</h3>
                     <div class="form-group"><label for="recommendations">التوصيات العامة</label><textarea id="recommendations" class="form-control" rows="6" placeholder="أدخل التوصيات العامة"></textarea></div>
                     <button class="btn" id="saveRecommendationsBtn">حفظ التوصيات</button>
                 </div>
            </div>

            <div class="tab-content" id="improvement-content">
                <h2>خطة التحسين المقترحة</h2>
                <div class="improvement-section">
                    <p>بناءً على التقييم الذاتي وملاحظات المتابعة، يمكن وضع خطة تحسين للجوانب التي تحتاج إلى تطوير في الأداء الوظيفي.</p>
                    <div class="improvement-form">
                        <div class="form-group"><label for="improvementArea">مجال التحسين</label><select id="improvementArea" class="form-control"><option value="">اختر مجال التحسين</option><option value="أداء الواجبات الوظيفية">أداء الواجبات الوظيفية</option><option value="التفاعل مع المجتمع المهني">التفاعل مع المجتمع المهني</option></select></div>
                        <div class="form-group"><label for="improvementPriority">أولوية التحسين</label><select id="improvementPriority" class="form-control"><option value="">اختر أولوية التحسين</option><option value="عالية">عالية</option><option value="متوسطة">متوسطة</option><option value="منخفضة">منخفضة</option></select></div>
                        <div class="form-group"><label for="improvementGoal">هدف التحسين</label><input type="text" id="improvementGoal" class="form-control" placeholder="أدخل هدف التحسين"></div>
                        <div class="form-group"><label for="improvementActions">الإجراءات المقترحة</label><textarea id="improvementActions" class="form-control" rows="4" placeholder="أدخل الإجراءات المقترحة"></textarea></div>
                        <div class="form-group"><label for="improvementStartDate">تاريخ البداية</label><input type="date" id="improvementStartDate" class="form-control"></div>
                        <div class="form-group"><label for="improvementEndDate">تاريخ النهاية</label><input type="date" id="improvementEndDate" class="form-control"></div>
                        <button class="btn" id="addImprovementBtn">إضافة خطة تحسين</button>
                    </div>
                    <div class="improvement-list" id="improvementList"></div>
                </div>
            </div>

        </div>
    </div>
    
    <div class="modal" id="noteModal"><div class="modal-content"><span class="close-modal" id="closeNoteModal">&times;</span><h2>إضافة ملاحظة</h2><div class="form-group"><label for="noteText">الملاحظة</label><textarea id="noteText" class="form-control" rows="6" placeholder="أدخل ملاحظتك هنا"></textarea></div><button class="btn" id="saveNoteBtn">حفظ الملاحظة</button></div></div>
    <div class="image-preview-modal" id="imagePreviewModal"><span class="close-preview" id="closePreviewModal">&times;</span><div class="image-preview-content"><img src="" alt="معاينة الصورة" class="preview-image" id="previewImage"></div></div>
    
    <footer><div class="container"><div class="footer-content"><span>جميع الحقوق محفوظة لقناة رسم للتصميم والخدمات التعليمية</span><img src="https://h.top4top.io/p_3453yqc3h0.png" alt="شعار رسم" class="footer-logo"><a href="https://t.me/Rasm_MA1" target="_blank" class="footer-link">https://t.me/Rasm_MA1</a></div></div></footer>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js"></script>
    <script type="module">
        // START: Firebase Initialization
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

        // *** ضع كائن إعدادات Firebase هنا ***
        const firebaseConfig = {
          apiKey: "YOUR_API_KEY",
          authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
          projectId: "YOUR_PROJECT_ID",
          storageBucket: "YOUR_PROJECT_ID.appspot.com",
          messagingSenderId: "YOUR_SENDER_ID",
          appId: "YOUR_APP_ID"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        let userId = null; // سيتم تعيينه بعد تسجيل الدخول
        // END: Firebase Initialization

        // Global Variables
        let currentNoteItemId = null;
        
        // Performance Indicators Data
        const performanceIndicators = [
            { id: 'performance_1', title: 'أداء الواجبات الوظيفية', description: 'مدى التزام المعلم بأداء واجباته الوظيفية وفق اللوائح والأنظمة المعتمدة.', weight: 10 },
            { id: 'performance_2', title: 'التفاعل مع المجتمع المهني', description: 'مشاركة المعلم في الأنشطة المهنية والتعاون مع الزملاء والمجتمع المدرسي.', weight: 10 },
            { id: 'performance_3', title: 'التفاعل مع أولياء الأمور', description: 'التواصل الفعال مع أولياء الأمور وإشراكهم في العملية التعليمية.', weight: 10 },
            { id: 'performance_4', title: 'تنويع استراتيجيات التدريس', description: 'استخدام استراتيجيات تدريس متنوعة تناسب احتياجات المتعلمين وأنماط تعلمهم.', weight: 10 },
            { id: 'performance_5', title: 'تحسين نتائج المتعلمين', description: 'العمل على تحسين نتائج المتعلمين وتطوير مستوياتهم التحصيلية.', weight: 10 },
            { id: 'performance_6', title: 'إعداد وتنفيذ خطة التعلم', description: 'إعداد وتنفيذ خطط تعليمية فعالة تحقق أهداف المنهج.', weight: 10 },
            { id: 'performance_7', title: 'توظيف التقنيات والوسائل', description: 'استخدام التقنيات والوسائل التعليمية المناسبة لتعزيز عملية التعلم.', weight: 10 },
            { id: 'performance_8', title: 'تهيئة البيئة التعليمية', description: 'تهيئة بيئة تعليمية محفزة وآمنة للمتعلمين.', weight: 5 },
            { id: 'performance_9', title: 'الإدارة الصفية', description: 'إدارة الصف بفاعلية وتنظيم وقت التعلم بكفاءة.', weight: 5 },
            { id: 'performance_10', title: 'تحليل نتائج المتعلمين', description: 'تحليل نتائج المتعلمين واستخدامها في تحسين الممارسات التعليمية.', weight: 10 },
            { id: 'performance_11', title: 'تنوع أساليب التقويم', description: 'استخدام أساليب تقويم متنوعة لقياس تقدم المتعلمين.', weight: 10 }
        ];

        // --- AUTHENTICATION & INITIALIZATION ---
        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in anonymously.
                userId = user.uid;
                console.log("User signed in anonymously with UID:", userId);
                initializeApp();
            } else {
                // User is signed out. Sign in again.
                signInAnonymously(auth).catch(error => {
                    console.error("Error signing in anonymously:", error);
                    alert("حدث خطأ أثناء الاتصال بالخدمة. يرجى تحديث الصفحة.");
                });
            }
        });

        async function initializeApp() {
            setupEventListeners();
            await loadAllDataFromFirebase();
        }

        async function loadAllDataFromFirebase() {
            if (!userId) return;
            const docRef = doc(db, "profiles", userId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                console.log("Data loaded from Firebase:", data);
                // Load data into UI
                updateHeaderInfo(data.basicInfo);
                updateCvInputs(data.cv);
                updateLicensePreview(data.cv?.licenseImageUrl);
                renderCertificates(data.cv?.certificates || []);
                renderCourses(data.cv?.courses || []);
                renderPerformanceItems(data.performanceData || []);
                updateDocumentation(data.documentation);
                renderImprovementPlans(data.improvements || []);
            } else {
                console.log("No such document! Initializing new profile.");
                // If no data exists, just render the empty templates
                 renderPerformanceItems([]);
                 renderCertificates([]);
                 renderCourses([]);
                 renderImprovementPlans([]);
            }
        }
        
        // --- UI RENDERING FUNCTIONS ---
        function updateHeaderInfo(basicInfo = {}) {
            const { teacherName, educationDept, schoolName, academicYear } = basicInfo;
            document.getElementById('teacherName').textContent = `اسم المعلم: ${teacherName || '-'}`;
            document.getElementById('educationDept').textContent = `الإدارة التعليمية: ${educationDept || '-'}`;
            document.getElementById('schoolName').textContent = `المدرسة: ${schoolName || '-'}`;
            document.getElementById('academicYear').textContent = `العام الدراسي: ${academicYear || '-'}`;
            
            document.getElementById('teacherNameInput').value = teacherName || '';
            document.getElementById('educationDeptInput').value = educationDept || '';
            document.getElementById('schoolNameInput').value = schoolName || '';
            document.getElementById('academicYearInput').value = academicYear || '';
        }

        function updateCvInputs(cvData = {}) {
            const { fullName, specialty, qualification, yearsOfExperience } = cvData;
            document.getElementById('fullNameInput').value = fullName || '';
            document.getElementById('specialtyInput').value = specialty || '';
            document.getElementById('qualificationInput').value = qualification || '';
            document.getElementById('yearsOfExperienceInput').value = yearsOfExperience || '';
        }

        function updateLicensePreview(url) {
             const licensePreview = document.getElementById('licensePreview');
             if(url) {
                licensePreview.innerHTML = `<img src="${url}" alt="الرخصة المهنية">`;
             } else {
                licensePreview.innerHTML = `<div class="certificate-placeholder">+</div>`;
             }
        }

        function renderCertificates(certificates = []) {
            const container = document.getElementById('certificatesContainer');
            container.innerHTML = '';
            certificates.forEach(cert => {
                const certItem = document.createElement('div');
                certItem.className = 'certificate-item';
                certItem.innerHTML = `<img src="${cert.url}" alt="شهادة">`;
                certItem.onclick = () => showImagePreview(cert.url);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.style.position = 'absolute';
                deleteBtn.style.top = '5px';
                deleteBtn.style.right = '5px';
                deleteBtn.innerHTML = '×';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteCertificate(cert);
                };
                certItem.appendChild(deleteBtn);
                container.appendChild(certItem);
            });
             if (certificates.length < 8) {
                const addItem = document.createElement('div');
                addItem.className = 'certificate-item certificate-add';
                addItem.innerHTML = '<div class="certificate-placeholder">+</div>';
                addItem.onclick = () => document.getElementById('certificateUpload').click();
                container.appendChild(addItem);
            }
        }

        function renderCourses(courses = []) {
             const list = document.getElementById('coursesList');
             list.innerHTML = '';
             courses.forEach(course => {
                 const item = document.createElement('div');
                 item.className = 'course-item';
                 item.innerHTML = `
                    <div>
                        <strong>${course.name}</strong>
                        <p>الجهة: ${course.provider} | التاريخ: ${formatDate(course.date)} | عدد الساعات: ${course.hours}</p>
                    </div>
                    <button class="delete-btn">حذف</button>
                 `;
                 item.querySelector('.delete-btn').onclick = () => deleteCourse(course);
                 list.appendChild(item);
             });
        }
        
        function renderPerformanceItems(performanceData = []) {
            const container = document.getElementById('performanceItems');
            container.innerHTML = '';
            performanceIndicators.forEach(indicator => {
                const data = performanceData.find(item => item.id === indicator.id) || { id: indicator.id, rating: 0, note: '', files: [] };
                const itemElement = document.createElement('div');
                itemElement.className = 'performance-item';
                itemElement.id = indicator.id;
                
                itemElement.innerHTML = `
                    <div class="performance-header">
                        <h3 class="performance-title">${indicator.title} (${indicator.weight}%)</h3>
                        <button class="note-btn" data-id="${indicator.id}"><i class="fas fa-sticky-note note-icon"></i></button>
                    </div>
                    <p class="performance-description">${indicator.description}</p>
                    <div class="performance-uploads">
                        <label>الشواهد (الحد الأقصى 4 ملفات)</label>
                        <div class="upload-container" id="uploads_${indicator.id}"></div>
                    </div>
                    <div class="performance-rating">
                        <label>التقييم الذاتي</label>
                        <div class="rating-container">
                            <span class="rating-value">${data.rating}</span>
                            <div class="rating-slider-container">
                                <input type="range" min="0" max="5" step="1" value="${data.rating}" class="rating-slider" data-id="${indicator.id}">
                            </div>
                        </div>
                    </div>
                    <div class="performance-note" style="${data.note ? 'display: block;' : ''}">
                        <label>الملاحظات</label><textarea readonly>${data.note || ''}</textarea>
                    </div>`;
                container.appendChild(itemElement);

                // Render uploads
                const uploadContainer = itemElement.querySelector(`#uploads_${indicator.id}`);
                (data.files || []).forEach(file => {
                    const fileElement = createFileElement(file, indicator.id);
                    uploadContainer.appendChild(fileElement);
                });
                const addUploadBtn = document.createElement('div');
                addUploadBtn.className = 'upload-item upload-add';
                addUploadBtn.innerHTML = '<div class="upload-placeholder">+</div>';
                addUploadBtn.onclick = () => handlePerformanceFileUpload(indicator.id);
                uploadContainer.appendChild(addUploadBtn);
            });
            addPerformanceEventListeners();
            calculateTotalScore(performanceData);
        }

        function createFileElement(file, performanceId) {
            const fileElement = document.createElement('div');
            fileElement.className = 'upload-item';
            
            if (file.type.startsWith('image/')) {
                fileElement.innerHTML = `<img src="${file.url}" alt="شاهد">`;
                fileElement.onclick = () => showImagePreview(file.url);
            } else {
                fileElement.innerHTML = `<div class="upload-file-icon"><i class="fas fa-file-pdf"></i></div>`;
                fileElement.onclick = () => window.open(file.url, '_blank');
            }

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.style.position = 'absolute';
            deleteBtn.style.top = '5px';
            deleteBtn.style.right = '5px';
            deleteBtn.innerHTML = '×';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                deletePerformanceFile(performanceId, file);
            };
            fileElement.appendChild(deleteBtn);
            return fileElement;
        }
        
        function updateDocumentation(docData = {}) {
            const { firstFollowup = {}, secondFollowup = {}, recommendations = '' } = docData;
            document.getElementById('firstFollowupDate').value = firstFollowup.date || '';
            document.getElementById('firstFollowupName').value = firstFollowup.name || '';
            document.getElementById('firstFollowupNotes').value = firstFollowup.notes || '';
            document.getElementById('secondFollowupDate').value = secondFollowup.date || '';
            document.getElementById('secondFollowupName').value = secondFollowup.name || '';
            document.getElementById('secondFollowupNotes').value = secondFollowup.notes || '';
            document.getElementById('recommendations').value = recommendations;
        }
        
        function renderImprovementPlans(improvements = []) {
            const list = document.getElementById('improvementList');
            list.innerHTML = '';
            improvements.forEach(item => {
                const priorityClass = item.priority === 'عالية' ? 'priority-high' : item.priority === 'متوسطة' ? 'priority-medium' : 'priority-low';
                const itemEl = document.createElement('div');
                itemEl.className = 'improvement-item';
                itemEl.innerHTML = `
                    <h4>${item.area}</h4>
                    <p><strong>الأولوية:</strong> <span class="${priorityClass}">${item.priority}</span></p>
                    <p><strong>الهدف:</strong> ${item.goal}</p>
                    <p><strong>الإجراءات المقترحة:</strong> ${item.actions}</p>
                    <p><strong>الفترة الزمنية:</strong> ${formatDate(item.startDate)} إلى ${formatDate(item.endDate)}</p>
                    <button class="delete-btn">حذف</button>
                `;
                itemEl.querySelector('.delete-btn').onclick = () => deleteImprovementPlan(item);
                list.appendChild(itemEl);
            });
        }

        // --- EVENT LISTENERS SETUP ---
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = link.getAttribute('data-tab');
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    link.classList.add('active');
                    document.getElementById(`${tabId}-content`).classList.add('active');
                });
            });
            
            // Save Buttons
            document.getElementById('saveBasicDataBtn').onclick = saveBasicData;
            document.getElementById('saveCvDataBtn').onclick = saveCvData;
            document.getElementById('addCourseBtn').onclick = addCourse;
            document.getElementById('saveFirstFollowupBtn').onclick = saveDocumentation;
            document.getElementById('saveSecondFollowupBtn').onclick = saveDocumentation;
            document.getElementById('saveRecommendationsBtn').onclick = saveDocumentation;
            document.getElementById('addImprovementBtn').onclick = addImprovementPlan;
            
            // File Uploads
            document.getElementById('licenseUpload').onchange = (e) => uploadLicense(e.target.files[0]);
            document.getElementById('certificateUploadBtn').onclick = () => document.getElementById('certificateUpload').click();
            document.getElementById('certificateUpload').onchange = (e) => uploadCertificate(e.target.files[0]);
            
            // Modals
            document.getElementById('closeNoteModal').onclick = () => document.getElementById('noteModal').style.display = 'none';
            document.getElementById('saveNoteBtn').onclick = saveNote;
            document.getElementById('closePreviewModal').onclick = () => document.getElementById('imagePreviewModal').style.display = 'none';
        }
        
        function addPerformanceEventListeners() {
            document.querySelectorAll('.note-btn').forEach(btn => btn.onclick = () => openNoteModal(btn.dataset.id));
            document.querySelectorAll('.rating-slider').forEach(slider => {
                slider.oninput = () => {
                    const value = slider.value;
                    const id = slider.dataset.id;
                    slider.parentElement.previousElementSibling.textContent = value;
                    updatePerformanceRating(id, parseInt(value));
                };
            });
        }
        
        // --- DATA SAVING/UPDATING FUNCTIONS ---
        async function saveBasicData() {
            const data = {
                teacherName: document.getElementById('teacherNameInput').value,
                educationDept: document.getElementById('educationDeptInput').value,
                schoolName: document.getElementById('schoolNameInput').value,
                academicYear: document.getElementById('academicYearInput').value
            };
            await setDoc(doc(db, "profiles", userId), { basicInfo: data }, { merge: true });
            updateHeaderInfo(data);
            alert('تم حفظ البيانات بنجاح');
        }

        async function saveCvData() {
             const data = {
                fullName: document.getElementById('fullNameInput').value,
                specialty: document.getElementById('specialtyInput').value,
                qualification: document.getElementById('qualificationInput').value,
                yearsOfExperience: document.getElementById('yearsOfExperienceInput').value
            };
            await updateDoc(doc(db, "profiles", userId), { "cv.basic": data });
            alert('تم حفظ بيانات السيرة الذاتية بنجاح');
        }
        
        async function uploadFile(file, path) {
            if (!userId || !file) return null;
            const storageRef = ref(storage, `profiles/${userId}/${path}/${Date.now()}-${file.name}`);
            await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(storageRef);
            return downloadURL;
        }

        async function uploadLicense(file) {
            if(!file) return;
            const url = await uploadFile(file, 'license');
            if(url) {
                await updateDoc(doc(db, "profiles", userId), { "cv.licenseImageUrl": url });
                updateLicensePreview(url);
                alert('تم رفع صورة الرخصة بنجاح');
            }
        }
        
        async function uploadCertificate(file) {
             if(!file) return;
             const url = await uploadFile(file, 'certificates');
             if(url) {
                const newCert = { id: `cert_${Date.now()}`, url: url };
                await updateDoc(doc(db, "profiles", userId), { "cv.certificates": arrayUnion(newCert) });
                const docSnap = await getDoc(doc(db, "profiles", userId));
                renderCertificates(docSnap.data().cv.certificates);
                alert('تم رفع الشهادة بنجاح');
             }
        }
        
        async function addCourse() {
            const newCourse = {
                id: `course_${Date.now()}`,
                name: document.getElementById('courseNameInput').value,
                provider: document.getElementById('courseProviderInput').value,
                date: document.getElementById('courseDateInput').value,
                hours: document.getElementById('courseHoursInput').value
            };
            if(!newCourse.name || !newCourse.provider) return alert('يرجى ملء حقول الدورة');
            
            await updateDoc(doc(db, "profiles", userId), { "cv.courses": arrayUnion(newCourse) });
            const docSnap = await getDoc(doc(db, "profiles", userId));
            renderCourses(docSnap.data().cv.courses);
            
            document.getElementById('courseNameInput').value = '';
            document.getElementById('courseProviderInput').value = '';
            document.getElementById('courseDateInput').value = '';
            document.getElementById('courseHoursInput').value = '';
        }
        
        async function updatePerformanceRating(performanceId, rating) {
             const docRef = doc(db, "profiles", userId);
             const docSnap = await getDoc(docRef);
             let performanceData = docSnap.data()?.performanceData || [];
             
             let itemIndex = performanceData.findIndex(item => item.id === performanceId);
             if (itemIndex === -1) {
                performanceData.push({ id: performanceId, rating: rating, note: '', files: [] });
             } else {
                performanceData[itemIndex].rating = rating;
             }
             
             await setDoc(docRef, { performanceData: performanceData }, { merge: true });
             calculateTotalScore(performanceData);
        }

        function openNoteModal(performanceId) {
             currentNoteItemId = performanceId;
             const noteText = document.querySelector(`#${performanceId} .performance-note textarea`).value;
             document.getElementById('noteText').value = noteText;
             document.getElementById('noteModal').style.display = 'block';
        }

        async function saveNote() {
            const note = document.getElementById('noteText').value;
            const docRef = doc(db, "profiles", userId);
            const docSnap = await getDoc(docRef);
            let performanceData = docSnap.data()?.performanceData || [];

            let itemIndex = performanceData.findIndex(item => item.id === currentNoteItemId);
            if(itemIndex !== -1) {
                performanceData[itemIndex].note = note;
            } else {
                performanceData.push({ id: currentNoteItemId, rating: 0, note: note, files: [] });
            }

            await setDoc(docRef, { performanceData: performanceData }, { merge: true });
            document.querySelector(`#${currentNoteItemId} .performance-note textarea`).value = note;
            document.querySelector(`#${currentNoteItemId} .performance-note`).style.display = note ? 'block' : 'none';
            document.getElementById('noteModal').style.display = 'none';
            alert('تم حفظ الملاحظة');
        }

        async function handlePerformanceFileUpload(performanceId) {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*,application/pdf';
            fileInput.onchange = async e => {
                const file = e.target.files[0];
                if (file) {
                    const url = await uploadFile(file, `performance/${performanceId}`);
                    if(url) {
                        const newFile = { id: `file_${Date.now()}`, url: url, type: file.type };
                        
                        const docRef = doc(db, "profiles", userId);
                        const docSnap = await getDoc(docRef);
                        let performanceData = docSnap.data()?.performanceData || [];

                        let itemIndex = performanceData.findIndex(item => item.id === performanceId);
                        if (itemIndex === -1) {
                            performanceData.push({ id: performanceId, rating: 0, note: '', files: [newFile] });
                        } else {
                            performanceData[itemIndex].files.push(newFile);
                        }
                        
                        await setDoc(docRef, { performanceData: performanceData }, { merge: true });
                        renderPerformanceItems(performanceData);
                        alert('تم رفع الشاهد بنجاح');
                    }
                }
            };
            fileInput.click();
        }
        
        async function saveDocumentation() {
             const data = {
                firstFollowup: {
                    date: document.getElementById('firstFollowupDate').value,
                    name: document.getElementById('firstFollowupName').value,
                    notes: document.getElementById('firstFollowupNotes').value,
                },
                secondFollowup: {
                    date: document.getElementById('secondFollowupDate').value,
                    name: document.getElementById('secondFollowupName').value,
                    notes: document.getElementById('secondFollowupNotes').value,
                },
                recommendations: document.getElementById('recommendations').value,
            };
            await setDoc(doc(db, "profiles", userId), { documentation: data }, { merge: true });
            alert('تم حفظ البيانات بنجاح');
        }

        async function addImprovementPlan() {
             const newItem = {
                id: `imp_${Date.now()}`,
                area: document.getElementById('improvementArea').value,
                priority: document.getElementById('improvementPriority').value,
                goal: document.getElementById('improvementGoal').value,
                actions: document.getElementById('improvementActions').value,
                startDate: document.getElementById('improvementStartDate').value,
                endDate: document.getElementById('improvementEndDate').value,
            };
            if(!newItem.area || !newItem.goal) return alert('يرجى ملء الحقول المطلوبة');
            await updateDoc(doc(db, "profiles", userId), { "improvements": arrayUnion(newItem) });
            const docSnap = await getDoc(doc(db, "profiles", userId));
            renderImprovementPlans(docSnap.data().improvements);
        }
        
        // --- DELETION FUNCTIONS ---
        async function deleteFileFromStorage(url) {
            try {
                const fileRef = ref(storage, url);
                await deleteObject(fileRef);
                return true;
            } catch (error) {
                console.error("Error deleting file from storage:", error);
                // If file not found, it's okay, just proceed.
                if (error.code === 'storage/object-not-found') return true;
                return false;
            }
        }
        
        async function deleteCertificate(certToDelete) {
            if(!confirm("هل أنت متأكد من حذف هذه الشهادة؟")) return;
            await deleteFileFromStorage(certToDelete.url);
            await updateDoc(doc(db, "profiles", userId), { "cv.certificates": arrayRemove(certToDelete) });
            const docSnap = await getDoc(doc(db, "profiles", userId));
            renderCertificates(docSnap.data().cv.certificates);
            alert('تم حذف الشهادة');
        }

        async function deleteCourse(courseToDelete) {
             if(!confirm("هل أنت متأكد من حذف هذه الدورة؟")) return;
             await updateDoc(doc(db, "profiles", userId), { "cv.courses": arrayRemove(courseToDelete) });
             const docSnap = await getDoc(doc(db, "profiles", userId));
             renderCourses(docSnap.data().cv.courses);
             alert('تم حذف الدورة');
        }

        async function deletePerformanceFile(performanceId, fileToDelete) {
            if(!confirm("هل أنت متأكد من حذف هذا الشاهد؟")) return;

            await deleteFileFromStorage(fileToDelete.url);

            const docRef = doc(db, "profiles", userId);
            const docSnap = await getDoc(docRef);
            let performanceData = docSnap.data()?.performanceData || [];
            let itemIndex = performanceData.findIndex(item => item.id === performanceId);

            if (itemIndex !== -1) {
                performanceData[itemIndex].files = performanceData[itemIndex].files.filter(f => f.id !== fileToDelete.id);
                await setDoc(docRef, { performanceData: performanceData }, { merge: true });
                renderPerformanceItems(performanceData);
                alert('تم حذف الشاهد');
            }
        }

        async function deleteImprovementPlan(itemToDelete) {
            if(!confirm("هل أنت متأكد من حذف خطة التحسين هذه؟")) return;
            await updateDoc(doc(db, "profiles", userId), { "improvements": arrayRemove(itemToDelete) });
            const docSnap = await getDoc(doc(db, "profiles", userId));
            renderImprovementPlans(docSnap.data().improvements);
            alert('تم حذف الخطة');
        }
        
        // --- UTILITY FUNCTIONS ---
        function calculateTotalScore(performanceData = []) {
            let totalWeightedScore = 0;
            let totalWeight = 0;
            let detailsHTML = '';
            
            performanceIndicators.forEach(indicator => {
                const data = performanceData.find(item => item.id === indicator.id);
                const rating = data ? data.rating : 0;
                const weightedScore = (rating / 5) * indicator.weight;
                
                totalWeightedScore += weightedScore;
                totalWeight += indicator.weight;
                
                detailsHTML += `<p>${indicator.title}: <span>${rating} من 5</span> <span>(${weightedScore.toFixed(1)}%)</span></p>`;
            });
            
            const finalScore = totalWeight > 0 ? (totalWeightedScore / totalWeight) * 100 : 0;
            
            document.getElementById('totalScore').textContent = `${finalScore.toFixed(1)}%`;
            document.getElementById('scoreDetails').innerHTML = detailsHTML;
        }
        
        function showImagePreview(url) {
            document.getElementById('previewImage').src = url;
            document.getElementById('imagePreviewModal').style.display = 'block';
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('ar-SA', options);
        }
    </script>
</body>
</html>
